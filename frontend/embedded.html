<!DOCTYPE html>
<html lang="pt-BR" class="tw-dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assinatura Embarcada - Fontara Financial</title>
    <meta
      name="description"
      content="Assine documentos digitalmente com diferentes experiências Docusign."
    />
    <link rel="shortcut icon" href="./assets/logo/logo.png" type="image/x-icon" />
    <link rel="stylesheet" href="./css/tailwind-build.css" />
    <link rel="stylesheet" href="./css/index.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css"
    />
    <script src="https://js-d.docusign.com/bundle.js"></script>
    <style>
      /* ... seus estilos existentes ... */
      body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      main {
        flex-grow: 1;
      }
    </style>
  </head>
  <body class="tw-flex tw-min-h-[100vh] tw-flex-col tw-bg-gray-50 dark:tw-bg-gray-800">
    <div id="header-placeholder"></div>

    <main class="tw-container tw-mx-auto tw-p-4 tw-pt-24">
      <h1 class="tw-text-3xl tw-font-bold tw-mb-6 tw-text-center dark:tw-text-white">
        Assinatura Embarcada via Docusign.js SDK
      </h1>
      <div class="tw-max-w-2xl tw-mx-auto tw-bg-white dark:tw-bg-gray-900 tw-p-8 tw-rounded-lg tw-shadow-lg">
        <form id="signingForm" class="tw-space-y-6">
            <div>
                <label for="signerEmail" class="form-label">Email do Signatário:</label>
                <input type="email" id="signerEmail" name="signerEmail" class="form-input-custom" required value="teste@gmail.com">
            </div>
            <div>
                <label for="signerName" class="form-label">Nome do Signatário:</label>
                <input type="text" id="signerName" name="signerName" class="form-input-custom" required value="Nome Teste">
            </div>
            <div>
                <label for="signerCountryCode" class="form-label">Código do País (Telefone):</label>
                <input type="text" id="signerCountryCode" name="signerCountryCode" class="form-input-custom" value="+55">
            </div>
            <div>
                <label for="signerPhoneNumber" class="form-label">Número do Telefone:</label>
                <input type="text" id="signerPhoneNumber" name="signerPhoneNumber" class="form-input-custom" value="11999999999">
            </div>
             <div>
                <label for="signerDocType" class="form-label">Tipo de Documento:</label>
                <input type="text" id="signerDocType" name="signerDocType" class="form-input-custom" value="CPF">
            </div>
            <div>
                <label for="signerDocNumber" class="form-label">Número do Documento:</label>
                <input type="text" id="signerDocNumber" name="signerDocNumber" class="form-input-custom" value="12345678900">
            </div>
            <div>
                <label for="signerAddress" class="form-label">Endereço Completo:</label>
                <input type="text" id="signerAddress" name="signerAddress" class="form-input-custom" value="Rua Exemplo, 123, Bairro, Cidade - UF, 00000-000">
            </div>

            <fieldset class="tw-space-y-2">
                <legend class="form-label">Escolha a experiência de assinatura:</legend>
                <div>
                    <input type="radio" id="experienceIframe" name="signingExperience" value="IFRAME" class="form-radio" checked>
                    <label for="experienceIframe" class="tw-ml-2 dark:tw-text-gray-300">iFrame na Página</label>
                </div>
                <div>
                    <input type="radio" id="experiencePopup" name="signingExperience" value="POPUP" class="form-radio">
                    <label for="experiencePopup" class="tw-ml-2 dark:tw-text-gray-300">Popup</label>
                </div>
                <div>
                    <input type="radio" id="experienceFocusMode" name="signingExperience" value="FOCUS_MODE_EMBED" class="form-radio">
                    <label for="experienceFocusMode" class="tw-ml-2 dark:tw-text-gray-300">Modo Focado (Embed)</label>
                </div>
            </fieldset>
            <button type="submit" id="submitEnvelopeBtn" class="btn tw-w-full">
                Iniciar Assinatura
            </button>
        </form>
      </div>

      <div id="docusign-modal" class="tw-fixed tw-inset-0 tw-bg-gray-900 tw-bg-opacity-75 tw-flex tw-items-center tw-justify-center tw-hidden tw-z-50">
        <div class="tw-bg-white dark:tw-bg-gray-800 tw-p-4 tw-rounded-lg tw-shadow-xl tw-w-11/12 tw-h-5/6 md:tw-w-3/4 md:tw-h-5/6 tw-relative">
          <button id="close-modal-btn" class="tw-absolute tw-top-2 tw-right-2 tw-text-gray-600 dark:tw-text-gray-300 hover:tw-text-gray-900 dark:hover:tw-text-white">
            <i class="bi bi-x-lg tw-text-2xl"></i>
          </button>
          <div id="docusign-embed-container" class="tw-w-full tw-h-full"></div>
        </div>
      </div>
    </main>
    <div id="footer-placeholder"></div>

    <script src="./scripts/partials-loader.js"></script> <script src="./scripts/components.js"></script>
    <script src="./scripts/index.js"></script> <script>
      document.addEventListener('DOMContentLoaded', async () => {
        // Carrega o header e o footer
        await loadHTML('./_header.html', 'header-placeholder');
        await loadHTML('./_footer.html', 'footer-placeholder');

        // (Opcional mas recomendado) Chame uma função para reinicializar/anexar scripts APÓS o HTML ser carregado
        if (typeof initializePageScripts === 'function') {
          initializePageScripts();
        }
        
        // Restante do seu script original de embedded.html para lidar com o formulário Docusign
        const form = document.getElementById('signingForm');
        const submitEnvelopeBtn = document.getElementById('submitEnvelopeBtn');
        const docusignModal = document.getElementById('docusign-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const embedContainer = document.getElementById('docusign-embed-container');

        // Lógica para fechar o modal
        if(closeModalBtn) {
            closeModalBtn.addEventListener('click', () => {
                if(docusignModal) docusignModal.classList.add('tw-hidden');
                if(embedContainer) embedContainer.innerHTML = ''; // Limpa o container
            });
        }
        
        function openSigningModal() {
            if(docusignModal) docusignModal.classList.remove('tw-hidden');
        }

        function closeSigningModal() {
            if(docusignModal) docusignModal.classList.add('tw-hidden');
            if(embedContainer) embedContainer.innerHTML = '';
        }


        if (form && submitEnvelopeBtn) {
          form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const originalButtonInnerHTML = submitEnvelopeBtn.innerHTML;
            submitEnvelopeBtn.disabled = true;
            submitEnvelopeBtn.innerHTML = '<span class="tw-animate-pulse">Processando...</span>';

            const formData = new FormData(form);
            const payload = {
              signerEmail: formData.get('signerEmail'),
              signerName: formData.get('signerName'),
              status: 'sent', // Obrigatório para DocuSign eSignature REST API
              // Campos adicionais que você possa ter no seu envelope/template
              signerCountryCode: formData.get('signerCountryCode'),
              signerPhoneNumber: formData.get('signerPhoneNumber'),
              signerDocType: formData.get('signerDocType'),
              signerDocNumber: formData.get('signerDocNumber'),
              signerAddress: formData.get('signerAddress')
            };

            // Obter a experiência de assinatura selecionada
            const selectedExperience = document.querySelector('input[name="signingExperience"]:checked').value;

            try {
              let response = await fetch('/.netlify/functions/docusign-actions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: "CREATE_ENVELOPE_FROM_TEMPLATE_RECIPIENT_PROVIDED", payload })
              });

              if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: `Erro HTTP ${response.status}` }));
                throw new Error(errorData.error || `Falha ao criar envelope.`);
              }
              const envelopeResult = await response.json();
              const envelopeId = envelopeResult.envelopeId; // Supondo que sua função retorne o ID do envelope

              // Passo 2: Obter a URL de assinatura embarcada
              const recipientViewPayload = {
                envelopeId: envelopeId,
                recipientEmail: payload.signerEmail,
                recipientName: payload.signerName,
                returnUrl: window.location.href, // Ou uma página de agradecimento
                authenticationMethod: 'None' // Ou o método apropriado
              };

              response = await fetch('/.netlify/functions/docusign-actions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: "GET_EMBEDDED_SIGNING_URL", payload: recipientViewPayload })
              });

              if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: `Erro HTTP ${response.status}` }));
                throw new Error(errorData.error || `Falha ao obter URL de assinatura.`);
              }
              const signingResult = await response.json();
              const signingUrl = signingResult.signingUrl;

              if (signingUrl) {
                if (window.DocuSign && typeof window.DocuSign.loadDocuSign === 'function') {
                    const docusignToken = signingResult.docusignToken || DOCUSIGN_IK; // Use o IK do seu ambiente
                    
                    window.DocuSign.loadDocuSign(docusignToken)
                      .then((docusign) => {
                        const signingExperience = docusign.signing({
                            url: signingUrl,
                            displayFormat: selectedExperience, // IFRAME, POPUP, FOCUS_MODE_EMBED
                            source: "WEB", // Opcional: para rastreamento
                            // Para IFRAME e FOCUS_MODE_EMBED, especifique o elemento container
                            container: selectedExperience !== 'POPUP' ? embedContainer : undefined, 
                            style: {
                                // Estilos para a experiência de assinatura
                                modal: { // Para FOCUS_MODE_EMBED como modal
                                    backdrop: "rgba(0,0,0,0.7)"
                                },
                                // Outras opções de estilo conforme a documentação do DocuSign.js
                            }
                        });
                        
                        if (selectedExperience !== 'POPUP' && embedContainer) {
                            embedContainer.innerHTML = ''; // Limpa antes de montar
                            openSigningModal(); // Abre o modal que contém o embedContainer
                            signingExperience.mount(embedContainer);
                        } else if (selectedExperience === 'POPUP') {
                            // A experiência POPUP abre automaticamente uma nova janela/aba
                        }
                        
                        signingExperience.on('ready', (event) => console.log("DocuSign Ready:", event));
                        signingExperience.on('sessionEnd', (event) => {
                            console.log("DocuSign Session End:", event); // Evento como 'SIGNING_COMPLETE', 'CANCEL', 'ERROR', etc.
                            closeSigningModal();
                            alert(`Evento de assinatura: ${event.type}`);
                            // Você pode redirecionar ou atualizar a UI aqui com base no event.type
                        });

                      })
                      .catch((ex) => {
                        console.error(`Erro ao carregar Docusign.js SDK: ${ex.message}`, ex);
                        closeSigningModal();
                        alert("Não foi possível carregar o componente de assinatura Docusign (SDK).");
                      });
                } else {
                    console.error("Docusign.js SDK não está carregado ou loadDocuSign não é uma função.");
                    alert("Componente de assinatura Docusign não pôde ser carregado (SDK não encontrado).");
                    closeSigningModal();
                }
              } else { 
                throw new Error("URL de assinatura não retornada."); 
              }
            } catch (error) {
              console.error("Erro no processo Docusign:", error);
              alert(`Ocorreu um erro: ${error.message}`);
            } finally {
              if(submitEnvelopeBtn) {
                  submitEnvelopeBtn.disabled = false;
                  submitEnvelopeBtn.innerHTML = originalButtonInnerHTML;
              }
            }
          });
        }
      });
    </script>
  </body>
</html>
