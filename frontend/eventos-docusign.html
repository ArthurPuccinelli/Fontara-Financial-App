<!DOCTYPE html>
<html lang="pt-BR" class="tw-dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Eventos Docusign Detalhados - Fontara Financial</title>
    <meta
      name="description"
      content="Visualização detalhada e personalizável dos últimos 100 eventos Docusign."
    />
    <link rel="shortcut icon" href="./assets/logo/logo.png" type="image/x-icon" />
    <link rel="stylesheet" href="./css/tailwind-build.css" />
    <link rel="stylesheet" href="./css/index.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css"
      integrity="sha512-dPXYcDub/aeb08c63jRq/k6GaKccl256JQy/AnOq7CAnEZ9FzSL9wSbcZkMp4R26vBsMLFYH4kQ67/bbV8XaCQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      .content-wrapper { min-height: 70vh; }
      .event-card {
        border: 1px solid #e2e8f0;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 0.5rem;
        transition: box-shadow 0.2s ease-in-out;
      }
      .dark .event-card {
        border-color: #4a5568; 
        background-color: #2d3748;
      }
      .event-card:hover {
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      }
      .dark .event-card:hover {
         box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3), 0 2px 4px -1px rgba(0,0,0,0.2);
      }
      .event-card strong { color: #2b6cb0; }
      .dark .event-card strong { color: #63b3ed; }
      pre {
        background-color: #f7fafc;
        padding: 0.75em 1em;
        border-radius: 0.375rem;
        overflow-x: auto;
        font-size: 0.8em;
        margin-top: 0.5rem;
        border: 1px solid #e2e8f0;
        max-height: 200px; /* Limita altura do pre */
      }
      .dark pre {
        background-color: #1a202c;
        color: #cbd5e0;
        border-color: #2d3748;
      }
      .filter-input {
        @apply tw-block tw-w-full md:tw-w-1/2 tw-px-3 tw-py-2 tw-border tw-border-gray-300 dark:tw-border-gray-600 tw-rounded-md tw-shadow-sm focus:tw-outline-none focus:tw-ring-indigo-500 focus:tw-border-indigo-500 sm:tw-text-sm dark:tw-bg-gray-700 dark:tw-text-white;
      }
      .delete-btn {
        @apply tw-ml-auto tw-px-3 tw-py-1 tw-bg-red-500 hover:tw-bg-red-600 tw-text-white tw-text-xs tw-font-semibold tw-rounded tw-shadow focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-red-500 focus:tw-ring-opacity-50 tw-transition-colors;
      }
      .form-checkbox { 
        @apply tw-h-4 tw-w-4 tw-text-indigo-600 tw-border-gray-300 dark:tw-border-gray-600 tw-rounded focus:tw-ring-indigo-500 dark:tw-bg-gray-700 dark:focus:tw-ring-offset-gray-800;
      }
      .form-checkbox-label {
        @apply tw-ml-2 tw-block tw-text-sm tw-font-medium tw-text-gray-700 dark:tw-text-gray-300 tw-cursor-pointer;
      }
      .form-label {
        @apply tw-block tw-text-sm tw-font-medium tw-text-gray-700 dark:tw-text-gray-300 tw-mb-1;
      }
      .filter-group legend {
        @apply tw-text-lg tw-font-semibold tw-mb-2 tw-mt-4;
      }
      .fieldset-grid {
        @apply tw-grid tw-grid-cols-2 sm:tw-grid-cols-3 md:tw-grid-cols-4 tw-gap-x-4 tw-gap-y-2;
      }
    </style>
  </head>
  <body class="tw-flex tw-min-h-[100vh] tw-flex-col tw-bg-[#fcfcfc] tw-text-black dark:tw-bg-black dark:tw-text-white">
    <header
      id="mainHeader" class="lg:tw-px-4 tw-max-w-[100vw] tw-max-w-lg:tw-mr-auto max-lg:tw-top-0 tw-fixed tw-top-4 lg:tw-left-1/2 lg:tw--translate-x-1/2 tw-z-20 tw-flex tw-h-[60px] tw-w-full tw-text-gray-700 tw-bg-white dark:tw-text-gray-200 dark:tw-bg-[#17181b] tw-px-[3%] tw-rounded-md lg:tw-max-w-5xl tw-shadow-md dark:tw-shadow-gray-700 lg:tw-justify-around lg:!tw-backdrop-blur-lg lg:tw-opacity-[0.99]">
      <a class="tw-flex tw-p-[4px] tw-gap-2 tw-place-items-center" href="index.html"><div class="tw-h-[30px] tw-max-w-[100px]"><img src="./assets/logo/logo.png" alt="Fontara Financial Logo" class="tw-object-contain tw-h-full tw-w-full dark:tw-invert"/></div></a>
      <div class="collapsible-header animated-collapse max-lg:tw-shadow-md" id="collapsed-header-items"><nav class="tw-relative tw-flex tw-h-full max-lg:tw-h-max tw-w-max tw-gap-5 tw-text-base max-lg:tw-mt-[30px] max-lg:tw-flex-col max-lg:tw-gap-5 lg:tw-mx-auto tw-place-items-center"><a class="header-links" href="index.html#hero-section"> Início </a><a class="header-links" href="index.html#casos-de-sucesso"> Sucesso </a><a class="header-links" href="index.html#nossos-servicos"> Serviços </a><div class="tw-relative tw-flex tw-flex-col tw-place-items-center"><div id="nav-dropdown-toggle-0" class="max-lg:tw-max-w-fit tw-flex header-links tw-gap-1 tw-place-items-center"><span class=""> Soluções </span> <i class="tw-text-sm bi bi-chevron-down"></i></div><nav id="nav-dropdown-list-0" data-open="false" class="tw-scale-0 tw-opacity-0 lg:tw-fixed tw-flex lg:tw-top-[80px] lg:tw-left-1/2 lg:tw--translate-x-1/2 tw-w-[90%] tw-rounded-lg max-lg:tw-h-0 max-lg:tw-w-0 lg:tw-h-auto tw-overflow-hidden tw-bg-white dark:tw-bg-[#17181B] tw-duration-300 tw-transition-opacity tw-shadow-lg tw-p-4"><div class="tw-grid max-xl:tw-flex max-xl:tw-flex-col tw-justify-around tw-grid-cols-2 tw-w-full"><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="credito-imobiliario.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-house-door"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Crédito Imobiliário</div><p>Simulação e aprovação rápida de crédito</p></div></a><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="previdencia-privada.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-shield-shaded"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Previdência Privada</div><p>Garanta tranquilidade para o seu futuro.</p></div></a><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="seguros.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-umbrella"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Seguros</div><p>Proteja seu patrimônio e sua família</p></div></a><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="emprestimo-pessoal.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-cash-coin"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Empréstimo Pessoal</div><p>Crédito para você nos momentos mais difíceis.</p></div></a><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="financiamento.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-receipt-cutoff"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Financiamento</div><p>Conquiste seus sonhos</p></div></a><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="investimentos.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-graph-up-arrow"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Investimentos</div><p>Renda fixa, renda variável e tesouro direto.</p></div></a><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="assinatura-embarcada.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-vector-pen"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Assinatura Embarcada</div><p>Assine seus documentos de forma digital e integrada.</p></div></a><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="atualizacao-perfil-investidor.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-person-lines-fill"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Atualização do Perfil de Investidor</div><p>Mantenha seu perfil atualizado.</p></div></a></div></nav></div><a class="header-links" href="index.html#faq"> FAQ </a></nav><div class="lg:tw-mx-4 tw-flex tw-place-items-center tw-gap-[20px] tw-text-base max-md:tw-w-full max-md:tw-flex-col max-md:tw-place-content-center"><button type="button" onclick="toggleMode()" class="header-links tw-text-gray-600 dark:tw-text-gray-300" title="Alternar tema" id="theme-toggle"><i class="bi bi-sun" id="toggle-mode-icon"></i></button><a href="#" aria-label="Acessar sua conta" class="btn tw-flex tw-gap-3 tw-px-3 tw-py-2 tw-transition-transform tw-duration-[0.3s] hover:tw-translate-x-2"><span>Área do Cliente</span><i class="bi bi-arrow-right"></i></a></div></div><button class="bi bi-list tw-absolute tw-right-3 tw-top-3 tw-z-50 tw-text-3xl tw-text-gray-500 lg:tw-hidden" onclick="toggleHeader()" aria-label="menu" id="collapse-btn"></button>
    </header>

    <main class="tw-mt-20 tw-pt-10 tw-pb-10 tw-px-4 md:tw-px-[5%] lg:tw-px-[10%] content-wrapper">
      <div class="tw-container tw-mx-auto">
        <div class="tw-flex tw-flex-col sm:tw-flex-row sm:tw-justify-between sm:tw-items-center tw-mb-8">
            <h1 class="tw-text-3xl md:tw-text-4xl tw-font-semibold tw-mb-4 sm:tw-mb-0">Últimos 100 Eventos Docusign</h1>
            <button id="refreshDataBtn" class="btn tw-self-start sm:tw-self-auto">
                <i class="bi bi-arrow-clockwise tw-mr-2"></i>Atualizar Dados
            </button>
        </div>

        <div class="tw-mb-6 tw-p-4 md:tw-p-6 tw-bg-gray-50 dark:tw-bg-gray-800 tw-rounded-lg tw-shadow">
            <div class="tw-mb-4">
                <label for="filterInput" class="form-label">Filtrar por texto (ID do envelope, status, assunto, etc.):</label>
                <input type="text" id="filterInput" class="filter-input" placeholder="Digite para filtrar...">
            </div>
            
            <div class="tw-mb-4">
                <label class="form-label tw-mb-2">Filtrar por tipo de evento Docusign:</label>
                <div id="eventTypeFiltersContainer" class="fieldset-grid">
                    {/* Checkboxes de tipo de evento serão inseridos aqui pelo JavaScript */}
                </div>
            </div>

            <div>
                <label class="form-label tw-mb-2">Mostrar/Ocultar Campos de Informação:</label>
                <div id="fieldVisibilityFiltersContainer" class="fieldset-grid">
                    {/* Checkboxes de visibilidade de campo serão inseridos aqui */}
                </div>
            </div>
        </div>

        <div id="eventListContainer">
          <p id="loadingMessage" class="tw-text-center tw-py-4">Carregando eventos...</p>
          {/* Os cards de eventos serão inseridos aqui */}
        </div>
      </div>
    </main>

    <footer class="tw-mt-auto tw-flex tw-flex-col tw-w-full tw-gap-4 tw-text-sm tw-pt-[5%] tw-pb-10 tw-px-[5%] md:tw-px-[10%] tw-text-black dark:tw-text-white max-md:tw-flex-col">
        <div class="tw-flex max-md:tw-flex-col max-md:tw-gap-6 tw-gap-3 tw-w-full tw-place-content-around"><div class="tw-flex tw-h-full tw-w-[250px] tw-flex-col tw-place-items-center tw-gap-6 max-md:tw-w-full"><a href="index.html" class="tw-w-full tw-place-items-center tw-flex tw-flex-col tw-gap-6"><img src="./assets/logo/logo.png" alt="Fontara Financial Logo" class="tw-max-w-[120px] dark:tw-invert"/></a><div class="tw-flex tw-gap-4 tw-text-lg"><a href="https://github.com/PaulleDemon/" aria-label="Github" target="_blank" rel="noopener"><i class="bi bi-github"></i></a><a href="https://twitter.com/pauls_freeman" aria-label="Twitter" target="_blank" rel="noopener"><i class="bi bi-twitter"></i></a><a href="https://www.linkedin.com/" aria-label="Linkedin" target="_blank" rel="noopener"><i class="bi bi-linkedin"></i></a></div></div><div class="tw-flex max-md:tw-flex-col tw-flex-wrap tw-gap-6 tw-h-full tw-w-full tw-justify-around"><div class="tw-flex tw-h-full tw-w-[200px] tw-flex-col tw-gap-4"><h2 class="tw-text-xl">Recursos</h2><div class="tw-flex tw-flex-col tw-gap-3"><a href="#" class="footer-link">Blog Financeiro</a><a href="#" class="footer-link">Simuladores</a><a href="#" class="footer-link">Glossário Financeiro</a><a href="#" class="footer-link">Status dos Serviços</a><a href="#" class="footer-link">Taxas e Tarifas</a></div></div><div class="tw-flex tw-h-full tw-w-[200px] tw-flex-col tw-gap-4"><h2 class="tw-text-xl">Fontara</h2><div class="tw-flex tw-flex-col tw-gap-3"><a href="#" class="footer-link">Sobre Nós</a><a href="#" class="footer-link">Carreiras</a><a href="#" class="footer-link">Imprensa</a><a href="#" class="footer-link">Fale Conosco</a><a href="#" class="footer-link">Compliance</a></div></div><div class="tw-flex tw-h-full tw-w-[200px] tw-flex-col tw-gap-4"><h2 class="tw-text-xl">Legal</h2><div class="tw-flex tw-flex-col tw-gap-3"><a href="#" class="footer-link">Termos de Uso</a><a href="#" class="footer-link">Política de Privacidade</a><a href="#" class="footer-link">Ouvidoria</a></div></div></div></div><hr class="tw-mt-8" /><div class="tw-mt-2 tw-flex tw-gap-2 tw-flex-col tw-text-gray-700 dark:tw-text-gray-300 tw-place-items-center tw-text-[12px] tw-w-full tw-text-center tw-place-content-around"><span>Copyright &#169; 2023-<span id="current-year"></span> Fontara Financial. Todos os direitos reservados.</span><span>Todas as marcas registradas e direitos autorais pertencem aos seus respectivos proprietários.</span></div>
    </footer>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const yearSpan = document.getElementById('current-year');
        if (yearSpan) yearSpan.textContent = new Date().getFullYear();

        const eventListContainer = document.getElementById('eventListContainer');
        const loadingMessage = document.getElementById('loadingMessage');
        const refreshDataBtn = document.getElementById('refreshDataBtn');
        const filterInput = document.getElementById('filterInput');
        const eventTypeFiltersContainer = document.getElementById('eventTypeFiltersContainer');
        const fieldVisibilityFiltersContainer = document.getElementById('fieldVisibilityFiltersContainer');

        let allFetchedEvents = []; 
        
        const docusignEventGroups = [
            {
                groupName: "Eventos do Envelope",
                events: [
                    { label: "Enviado", value: "envelope-sent" }, { label: "Entregue", value: "envelope-delivered" },
                    { label: "Concluído", value: "envelope-completed" }, { label: "Recusado", value: "envelope-declined" },
                    { label: "Anulado", value: "envelope-voided" }, { label: "Reenviado", value: "envelope-resent" },
                    { label: "Corrigido", value: "envelope-corrected" }, { label: "Criado", value: "envelope-created" }
                    // Adicione 'envelope-purge', 'envelope-deleted' se vierem do Connect
                ]
            },
            {
                groupName: "Eventos de Destinatários",
                events: [
                    { label: "Enviado para Dest.", value: "recipient-sent" }, { label: "Entregue ao Dest.", value: "recipient-delivered" },
                    { label: "Concluído pelo Dest.", value: "recipient-completed" }, { label: "Recusado pelo Dest.", value: "recipient-declined" },
                    { label: "Falha na Autenticação", value: "recipient-authenticationfailed" },
                    { label: "Reatribuído", value: "recipient-reassign"}, { label: "Concluir Mais Tarde", value: "recipient-finish-later"} // Docusign usa 'recipient-finish-later'
                ]
            }
        ];

        // Campos que podem ser mostrados/ocultos
        const displayableFieldsConfig = [
            { key: "id", label: "ID da Função", defaultChecked: true },
            { key: "receivedAt", label: "Recebido em", defaultChecked: true },
            { key: "eventType", label: "Tipo de Evento", defaultChecked: true },
            { key: "relevantInfo.envelopeId", label: "ID do Envelope", defaultChecked: true },
            { key: "relevantInfo.status", label: "Status Envelope", defaultChecked: true },
            { key: "relevantInfo.subject", label: "Assunto", defaultChecked: true },
            { key: "relevantInfo.timeGeneratedEvent", label: "Gerado (Docusign)", defaultChecked: false },
            { key: "relevantInfo.statusChangedDateTime", label: "Status Alterado (Docusign)", defaultChecked: false },
            { key: "relevantInfo.recipientsPreview", label: "Destinatários", defaultChecked: false },
            { key: "relevantInfo.message", label: "Msg Extração/Erro", defaultChecked: true },
            { key: "relevantInfo.rawPreview", label: "Preview Payload Bruto", defaultChecked: false }
        ];

        function populateEventTypeFilters() {
            if (!eventTypeFiltersContainer) return;
            eventTypeFiltersContainer.innerHTML = ''; 

            docusignEventGroups.forEach(group => {
                const fieldset = document.createElement('fieldset');
                fieldset.className = 'tw-mb-3';
                const legend = document.createElement('legend');
                legend.className = 'form-label tw-font-medium tw-text-base tw-mb-1';
                legend.textContent = group.groupName;
                fieldset.appendChild(legend);
                const gridDiv = document.createElement('div');
                gridDiv.className = 'fieldset-grid';

                group.events.forEach(evt => {
                    const div = document.createElement('div');
                    div.className = 'tw-flex tw-items-center';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `filter-type-${evt.value}`;
                    checkbox.name = 'eventTypeFilter';
                    checkbox.value = evt.value;
                    checkbox.className = 'form-checkbox event-type-filter';
                    checkbox.addEventListener('change', applyFilters);
                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.className = 'form-checkbox-label';
                    label.textContent = evt.label;
                    div.appendChild(checkbox);
                    div.appendChild(label);
                    gridDiv.appendChild(div);
                });
                fieldset.appendChild(gridDiv);
                eventTypeFiltersContainer.appendChild(fieldset);
            });
        }
        
        function populateFieldVisibilityFilters() {
            if (!fieldVisibilityFiltersContainer) return;
            fieldVisibilityFiltersContainer.innerHTML = '';
            const gridDiv = document.createElement('div');
            gridDiv.className = 'fieldset-grid';

            displayableFieldsConfig.forEach(field => {
                const div = document.createElement('div');
                div.className = 'tw-flex tw-items-center';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `vis-filter-${field.key.replace('.', '-')}`;
                checkbox.name = 'fieldVisibilityFilter';
                checkbox.value = field.key;
                checkbox.className = 'form-checkbox field-visibility-filter';
                checkbox.checked = field.defaultChecked; // Define o estado padrão
                checkbox.addEventListener('change', applyFilters); // Re-renderiza ao mudar visibilidade
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.className = 'form-checkbox-label';
                label.textContent = field.label;
                div.appendChild(checkbox);
                div.appendChild(label);
                gridDiv.appendChild(div);
            });
            fieldVisibilityFiltersContainer.appendChild(gridDiv);
        }


        function renderEvents(eventsToDisplay) {
            eventListContainer.innerHTML = ''; 
            if (!eventsToDisplay || eventsToDisplay.length === 0) {
                eventListContainer.innerHTML = '<p class="tw-text-center tw-py-10">Nenhum evento encontrado com os critérios atuais.</p>';
                return;
            }

            const visibleFields = {};
            document.querySelectorAll('.field-visibility-filter:checked').forEach(cb => {
                visibleFields[cb.value] = true;
            });

            eventsToDisplay.forEach(eventEntry => {
                const card = document.createElement('div');
                card.className = 'event-card dark:bg-gray-700 tw-shadow-md tw-p-4 tw-rounded-lg tw-mb-4 tw-text-left';
                
                let eventTypeLabel = eventEntry.eventType || 'Desconhecido';
                for (const group of docusignEventGroups) {
                    const foundEvent = group.events.find(e => e.eventValue === (eventEntry.eventType || '').toLowerCase());
                    if (foundEvent) { eventTypeLabel = foundEvent.label; break; }
                }

                let content = `<div class="tw-flex tw-justify-between tw-items-start"><div>`;
                if (visibleFields.id) content += `<p class="tw-text-xs tw-text-gray-500 dark:tw-text-gray-400"><strong>ID da Função:</strong> ${eventEntry.id || 'N/A'}</p>`;
                if (visibleFields.receivedAt) content += `<p><strong>Recebido em:</strong> ${eventEntry.receivedAt ? new Date(eventEntry.receivedAt).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'medium' }) : 'Data N/A'}</p>`;
                if (visibleFields.eventType) content += `<p><strong>Tipo de Evento:</strong> <span class="tw-font-semibold">${eventTypeLabel}</span></p>`;
                content += `</div>`;
                content += `<button data-event-id="${eventEntry.id}" class="delete-btn tw-ml-4"><i class="bi bi-trash3"></i> Excluir</button>`;
                content += `</div>`;
                
                if (Object.keys(visibleFields).length > 0) { // Só adiciona HR se houver campos visíveis abaixo
                    let hasRelevantInfoToShow = false;
                    if (eventEntry.relevantInfo) {
                        for(const key in eventEntry.relevantInfo){
                           if(visibleFields[`relevantInfo.${key}`]) { hasRelevantInfoToShow = true; break; }
                        }
                    }
                    if (hasRelevantInfoToShow || (eventEntry.relevantInfo && eventEntry.relevantInfo.message && visibleFields["relevantInfo.message"])) {
                         content += '<hr class="tw-my-3 dark:tw-border-gray-600">';
                    }
                }


                if (eventEntry.relevantInfo) {
                    if (eventEntry.relevantInfo.message && visibleFields["relevantInfo.message"]) {
                        content += `<p class="tw-text-orange-600 dark:tw-text-orange-400"><strong>Info:</strong> ${eventEntry.relevantInfo.message}</p>`;
                        if (eventEntry.relevantInfo.rawPreview && visibleFields["relevantInfo.rawPreview"]) {
                            content += `<p class="tw-mt-2"><strong>Preview Bruto:</strong></p><pre class="tw-text-xs">${eventEntry.relevantInfo.rawPreview.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre>`;
                        }
                    } else if (!eventEntry.relevantInfo.message) { // Só mostra outros campos se não houver mensagem de erro
                        if (visibleFields["relevantInfo.envelopeId"]) content += `<p><strong>ID do Envelope:</strong> ${eventEntry.relevantInfo.envelopeId || 'N/A'}</p>`;
                        if (visibleFields["relevantInfo.status"]) content += `<p><strong>Status Envelope:</strong> <span class="tw-font-semibold">${eventEntry.relevantInfo.status || 'N/A'}</span></p>`;
                        if (visibleFields["relevantInfo.subject"]) content += `<p><strong>Assunto:</strong> ${eventEntry.relevantInfo.subject || 'N/A'}</p>`;
                        if (eventEntry.relevantInfo.timeGeneratedEvent && visibleFields["relevantInfo.timeGeneratedEvent"]) {
                            content += `<p><strong>Gerado (Docusign):</strong> ${new Date(eventEntry.relevantInfo.timeGeneratedEvent).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'medium' })}</p>`;
                        }
                        if (eventEntry.relevantInfo.statusChangedDateTime && eventEntry.relevantInfo.statusChangedDateTime !== 'N/A' && visibleFields["relevantInfo.statusChangedDateTime"]) {
                            content += `<p><strong>Status Alterado (Docusign):</strong> ${new Date(eventEntry.relevantInfo.statusChangedDateTime).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'medium' })}</p>`;
                        }
                        if(eventEntry.relevantInfo.recipientsPreview && eventEntry.relevantInfo.recipientsPreview.length > 0 && visibleFields["relevantInfo.recipientsPreview"]){
                            content += `<div class="tw-mt-2"><p><strong>Destinatários:</strong></p><ul class="tw-list-disc tw-list-inside tw-ml-4">`;
                            eventEntry.relevantInfo.recipientsPreview.forEach(recip => { content += `<li>${recip}</li>`; });
                            content += `</ul></div>`;
                        }
                    }
                } else if (visibleFields.id || visibleFields.receivedAt || visibleFields.eventType) { // Se relevantInfo está totalmente ausente, mas outros campos são visíveis
                    content += `<p class="tw-text-red-500">Detalhes adicionais (relevantInfo) ausentes.</p>`
                }
                card.innerHTML = content;
                eventListContainer.appendChild(card);
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', handleDeleteEvent);
            });
        }

        async function fetchDocusignEvents() {
            if (loadingMessage && !eventListContainer.contains(loadingMessage) && eventListContainer.innerHTML === '') {
                eventListContainer.appendChild(loadingMessage);
            }
            if(loadingMessage) loadingMessage.textContent = 'Carregando eventos...';

            try {
                const response = await fetch('/.netlify/functions/get-docusign-events');
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `Erro HTTP: ${response.status}` }));
                    throw new Error(errorData.message || `Erro HTTP: ${response.status}`);
                }
                allFetchedEvents = await response.json(); 
                
                populateEventTypeFilters(); 
                populateFieldVisibilityFilters(); // Popula os checkboxes de visibilidade de campos

                if (loadingMessage) loadingMessage.remove();
                applyFilters(); 

            } catch (error) {
                console.error('Erro ao buscar eventos Docusign:', error);
                if (loadingMessage) loadingMessage.remove();
                eventListContainer.innerHTML = `<p class="tw-text-center tw-text-red-500 tw-py-10">Falha ao carregar eventos: ${error.message}</p>`;
            }
        }

        function applyFilters() {
            const filterText = filterInput.value.toLowerCase().trim();
            
            const selectedEventTypes = [];
            document.querySelectorAll('.event-type-filter:checked').forEach(checkbox => {
                selectedEventTypes.push(checkbox.value.toLowerCase()); 
            });

            let eventsToDisplay = allFetchedEvents;

            if (selectedEventTypes.length > 0) {
                eventsToDisplay = eventsToDisplay.filter(eventEntry => 
                    eventEntry.eventType && 
                    selectedEventTypes.includes(eventEntry.eventType.toLowerCase())
                );
            }

            if (filterText) {
                eventsToDisplay = eventsToDisplay.filter(eventEntry => {
                    const info = eventEntry.relevantInfo;
                    const eventTypeStr = eventEntry.eventType ? eventEntry.eventType.toLowerCase() : '';
                    const idStr = eventEntry.id ? eventEntry.id.toLowerCase() : '';
                    
                    let infoStr = '';
                    if (info) { // Concatena todos os valores de relevantInfo para busca de texto
                        Object.values(info).forEach(val => {
                            if(typeof val === 'string') infoStr += val.toLowerCase() + ' ';
                            else if (Array.isArray(val)) infoStr += val.join(' ').toLowerCase() + ' ';
                        });
                    }
                    const combinedSearchableText = `${eventTypeStr} ${idStr} ${infoStr}`;
                    return combinedSearchableText.includes(filterText);
                });
            }
            renderEvents(eventsToDisplay);
        }

        async function handleDeleteEvent(event) {
            const eventId = event.target.closest('.delete-btn').dataset.eventId;
            if (!eventId) return;

            if (confirm(`Tem certeza que deseja excluir o evento com ID: ${eventId}?`)) {
                try {
                    const response = await fetch('/.netlify/functions/delete-docusign-event', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ eventId: eventId })
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: `Erro HTTP: ${response.status}` }));
                        throw new Error(errorData.message || `Erro ao excluir evento: ${response.statusText}`);
                    }
                    // const result = await response.json(); // Descomente se quiser usar a mensagem de sucesso
                    fetchDocusignEvents(); 
                } catch (error) {
                    console.error("Erro ao excluir evento:", error);
                    alert(`Falha ao excluir evento: ${error.message}`);
                }
            }
        }

        if (refreshDataBtn) refreshDataBtn.addEventListener('click', fetchDocusignEvents);
        if (filterInput) filterInput.addEventListener('input', applyFilters);
        
        fetchDocusignEvents();
      });
    </script>
    <script src="./scripts/components.js"></script>
    <script src="./scripts/index.js"></script>
  </body>
</html>
