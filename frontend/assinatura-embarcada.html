<!DOCTYPE html>
<html lang="pt-BR" class="tw-dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assinatura Embarcada Avançada - Fontara Financial</title>
    <meta
      name="description"
      content="Escolha sua experiência de assinatura digital com Docusign.js: Clássica, Focada ou com Termos de Aceite."
    />
    <link rel="shortcut icon" href="./assets/logo/logo.png" type="image/x-icon" />
    <link rel="stylesheet" href="./css/tailwind-build.css" />
    <link rel="stylesheet" href="./css/index.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css"
    />
    <script src="https://js.docusign.com/bundle/docusign-esign-latest.js"></script>

    <style>
      .form-input-custom {
        @apply tw-block tw-w-full tw-px-4 tw-py-3 tw-border tw-border-black dark:tw-border-gray-500 tw-bg-gray-100 dark:tw-bg-gray-700 tw-rounded-md tw-shadow-sm focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-indigo-500 focus:tw-border-indigo-500 dark:tw-text-white tw-text-base;
        min-height: 50px; 
      }
      .form-label {
        @apply tw-block tw-text-base tw-font-medium tw-text-gray-700 dark:tw-text-gray-300 tw-mb-2; 
      }
      .form-checkbox, .form-radio { /* Estilo unificado para radio e checkbox */
        @apply tw-h-5 tw-w-5 tw-text-indigo-600 tw-border-gray-300 dark:tw-border-gray-600 focus:tw-ring-indigo-500 dark:tw-bg-gray-700 dark:focus:tw-ring-offset-gray-800;
      }
      .form-checkbox { @apply tw-rounded; }
      .form-radio { @apply tw-rounded-full; }

      .form-choice-label { /* Para labels ao lado dos checkboxes/radios */
        @apply tw-ml-2 tw-block tw-text-base tw-font-medium tw-text-gray-700 dark:tw-text-gray-300 tw-cursor-pointer;
      }
       .spinner-small {
        border: 3px solid #f3f3f3; border-top: 3px solid white; 
        border-radius: 50%; width: 20px; height: 20px;
        animation: spin 1s linear infinite; display: inline-block; margin-right: 0.5rem;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      /* Modal para Docusign.js e Iframe Clássico */
      .signing-modal-overlay {
        position: fixed; inset: 0;
        background-color: rgba(0,0,0,0.85);
        z-index: 5000 !important; /* Z-index alto */
        display: flex; /* Controlado por JS para mostrar/esconder */
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }
      .signing-modal-content {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        width: 90vw;
        height: 90vh;
        max-width: 1000px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative; /* Para z-index do botão fechar */
        z-index: 5001 !important;
      }
      .dark .signing-modal-content { background-color: #1f2937; }
      
      .modal-header-custom {
        padding: 0.75rem 1rem;
        background-color: #f3f4f6; /* tw-gray-100 */
        border-bottom: 1px solid #e5e7eb; /* tw-gray-300 */
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .dark .modal-header-custom { background-color: #374151; border-color: #4b5563; }
      .modal-title-custom { font-size: 1.1rem; font-weight: 600; }
      .close-modal-btn { font-size: 1.5rem; background:none; border:none; cursor:pointer; color: #6b7280; }
      .dark .close-modal-btn { color: #9ca3af; }

      #docusign-view-container { /* Para Docusign.js e para o iframe */
        flex-grow: 1;
        width: 100%;
        height: calc(100% - 50px); /* Subtrai altura aproximada do modal-header-custom */
      }
      #docusign-view-container iframe {
        width: 100%;
        height: 100%;
        border: none;
      }
    </style>
  </head>
  <body class="tw-flex tw-min-h-[100vh] tw-flex-col tw-bg-[#fcfcfc] tw-text-black dark:tw-bg-black dark:tw-text-white">
    <header id="mainHeader" class="lg:tw-px-4 tw-max-w-[100vw] tw-max-w-lg:tw-mr-auto max-lg:tw-top-0 tw-fixed tw-top-4 lg:tw-left-1/2 lg:tw--translate-x-1/2 tw-z-20 tw-flex tw-h-[60px] tw-w-full tw-text-gray-700 tw-bg-white dark:tw-text-gray-200 dark:tw-bg-[#17181b] tw-px-[3%] tw-rounded-md lg:tw-max-w-5xl tw-shadow-md dark:tw-shadow-gray-700 lg:tw-justify-around lg:!tw-backdrop-blur-lg lg:tw-opacity-[0.99]">
      <a class="tw-flex tw-p-[4px] tw-gap-2 tw-place-items-center" href="index.html"><div class="tw-h-[30px] tw-max-w-[100px]"><img src="./assets/logo/logo.png" alt="Fontara Financial Logo" class="tw-object-contain tw-h-full tw-w-full dark:tw-invert"/></div></a>
      <div class="collapsible-header animated-collapse max-lg:tw-shadow-md" id="collapsed-header-items"><nav class="tw-relative tw-flex tw-h-full max-lg:tw-h-max tw-w-max tw-gap-5 tw-text-base max-lg:tw-mt-[30px] max-lg:tw-flex-col max-lg:tw-gap-5 lg:tw-mx-auto tw-place-items-center"><a class="header-links" href="index.html#hero-section"> Início </a><a class="header-links" href="index.html#casos-de-sucesso"> Sucesso </a><a class="header-links" href="index.html#nossos-servicos"> Serviços </a><div class="tw-relative tw-flex tw-flex-col tw-place-items-center"><div id="nav-dropdown-toggle-0" class="max-lg:tw-max-w-fit tw-flex header-links tw-gap-1 tw-place-items-center"><span class=""> Soluções </span> <i class="tw-text-sm bi bi-chevron-down"></i></div><nav id="nav-dropdown-list-0" data-open="false" class="tw-scale-0 tw-opacity-0 lg:tw-fixed tw-flex lg:tw-top-[80px] lg:tw-left-1/2 lg:tw--translate-x-1/2 tw-w-[90%] tw-rounded-lg max-lg:tw-h-0 max-lg:tw-w-0 lg:tw-h-auto tw-overflow-hidden tw-bg-white dark:tw-bg-[#17181B] tw-duration-300 tw-transition-opacity tw-shadow-lg tw-p-4"><div class="tw-grid max-xl:tw-flex max-xl:tw-flex-col tw-justify-around tw-grid-cols-2 tw-w-full"><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="credito-imobiliario.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-house-door"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Crédito Imobiliário</div><p>Simulação e aprovação rápida de crédito</p></div></a><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="previdencia-privada.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-shield-shaded"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Previdência Privada</div><p>Garanta tranquilidade para o seu futuro.</p></div></a><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="seguros.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-umbrella"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Seguros</div><p>Proteja seu patrimônio e sua família</p></div></a><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="emprestimo-pessoal.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-cash-coin"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Empréstimo Pessoal</div><p>Crédito para você nos momentos mais difíceis.</p></div></a><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="financiamento.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-receipt-cutoff"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Financiamento</div><p>Conquiste seus sonhos</p></div></a><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="investimentos.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-graph-up-arrow"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Investimentos</div><p>Renda fixa, renda variável e tesouro direto.</p></div></a><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="assinatura-embarcada.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-vector-pen"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Assinatura Embarcada</div><p>Assine seus documentos de forma digital e integrada.</p></div></a><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="atualizacao-perfil-investidor.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-person-lines-fill"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Atualização do Perfil de Investidor</div><p>Mantenha seu perfil atualizado.</p></div></a></div></nav></div><a class="header-links" href="index.html#faq"> FAQ </a></nav><div class="lg:tw-mx-4 tw-flex tw-place-items-center tw-gap-[20px] tw-text-base max-md:tw-w-full max-md:tw-flex-col max-md:tw-place-content-center"><button type="button" onclick="toggleMode()" class="header-links tw-text-gray-600 dark:tw-text-gray-300" title="Alternar tema" id="theme-toggle"><i class="bi bi-sun" id="toggle-mode-icon"></i></button><a href="#" aria-label="Acessar sua conta" class="btn tw-flex tw-gap-3 tw-px-3 tw-py-2 tw-transition-transform tw-duration-[0.3s] hover:tw-translate-x-2"><span>Área do Cliente</span><i class="bi bi-arrow-right"></i></a></div></div><button class="bi bi-list tw-absolute tw-right-3 tw-top-3 tw-z-50 tw-text-3xl tw-text-gray-500 lg:tw-hidden" onclick="toggleHeader()" aria-label="menu" id="collapse-btn"></button>
    </header>

    <main class="tw-mt-20 tw-pt-10 tw-pb-10 tw-px-[5%] lg:tw-px-[10%]">
      <div class="tw-container tw-mx-auto lg:tw-max-w-5xl"> 
        <h1 class="tw-text-3xl md:tw-text-4xl tw-font-semibold tw-text-center tw-mb-8">Assinatura Embarcada Avançada</h1>
        
        <form id="envelopeForm" class="tw-space-y-6 tw-bg-white dark:tw-bg-gray-800 tw-p-6 md:tw-p-8 tw-rounded-lg tw-shadow-md">
          <div>
            <label for="signerName" class="form-label">Seu Nome Completo:</label>
            <input type="text" name="signerName" id="signerName" required class="form-input-custom" placeholder="Ex: João da Silva">
          </div>
          <div>
            <label for="signerEmail" class="form-label">Seu E-mail:</label>
            <input type="email" name="signerEmail" id="signerEmail" required class="form-input-custom" placeholder="Ex: joao.silva@email.com">
          </div>
          <div>
            <label for="emailSubject" class="form-label">Assunto do Documento:</label>
            <input type="text" name="emailSubject" id="emailSubject" required class="form-input-custom" value="Documento Fontara Financial para Assinatura">
          </div>

          <fieldset class="tw-pt-4">
            <legend class="form-label tw-mb-3">Escolha o Documento:</legend>
            <div class="tw-flex tw-items-center tw-mb-3">
              <input id="useDefaultDoc" name="documentChoice" type="radio" value="default" checked class="form-radio">
              <label for="useDefaultDoc" class="form-choice-label">Usar Contrato Padrão Fontara</label>
            </div>
            <div class="tw-flex tw-items-center">
              <input id="useUploadedDoc" name="documentChoice" type="radio" value="upload" class="form-radio">
              <label for="useUploadedDoc" class="form-choice-label">Enviar meu próprio documento (PDF)</label>
            </div>
          </fieldset>
          
          <div id="fileUploadContainer" class="tw-hidden"> 
            <label for="uploadedDoc" class="form-label">Selecione o arquivo PDF:</label>
            <input type="file" name="uploadedDoc" id="uploadedDoc" class="form-input-custom" accept=".pdf">
            <p class="tw-mt-1 tw-text-xs tw-text-gray-500 dark:tw-text-gray-400">O documento deve conter a âncora `\s1\` para assinatura.</p>
          </div>

          <fieldset class="tw-pt-4">
            <legend class="form-label tw-mb-3">Opções de Experiência de Assinatura:</legend>
            <div class="tw-space-y-3">
                <div class="tw-flex tw-items-center">
                  <input type="radio" id="expClassica" name="signingExperience" value="classic" checked class="form-radio">
                  <label for="expClassica" class="form-choice-label tw-ml-2">Experiência Clássica (Iframe Padrão)</label>
                </div>
                <div class="tw-flex tw-items-center">
                  <input type="radio" id="expFocused" name="signingExperience" value="focused" class="form-radio">
                  <label for="expFocused" class="form-choice-label tw-ml-2">Visualização Focada (UI Docusign Simplificada)</label>
                </div>
                <div class="tw-flex tw-items-center">
                  <input type="radio" id="expClickToAgree" name="signingExperience" value="click_to_agree" class="form-radio">
                  <label for="expClickToAgree" class="form-choice-label tw-ml-2">Apresentar Termos para Aceite (Click to Agree)</label>
                </div>
            </div>
          </fieldset>

          <div class="tw-pt-4">
            <button type="submit" id="submitEnvelopeBtn" class="btn tw-w-full tw-flex tw-justify-center tw-items-center tw-py-3 tw-px-4 tw-text-lg">
              <i class="bi bi-pencil-square tw-mr-2"></i><span id="submitBtnText">Assinar</span>
            </button>
          </div>
        </form>
      </div>
    </main>

    <footer class="tw-mt-auto tw-flex tw-flex-col tw-w-full tw-gap-4 tw-text-sm tw-pt-[5%] tw-pb-10 tw-px-[5%] md:tw-px-[10%] tw-text-black dark:tw-text-white max-md:tw-flex-col">
        <div class="tw-flex max-md:tw-flex-col max-md:tw-gap-6 tw-gap-3 tw-w-full tw-place-content-around"><div class="tw-flex tw-h-full tw-w-[250px] tw-flex-col tw-place-items-center tw-gap-6 max-md:tw-w-full"><a href="index.html" class="tw-w-full tw-place-items-center tw-flex tw-flex-col tw-gap-6"><img src="./assets/logo/logo.png" alt="Fontara Financial Logo" class="tw-max-w-[120px] dark:tw-invert"/></a><div class="tw-flex tw-gap-4 tw-text-lg"><a href="https://github.com/PaulleDemon/" aria-label="Github" target="_blank" rel="noopener"><i class="bi bi-github"></i></a><a href="https://twitter.com/pauls_freeman" aria-label="Twitter" target="_blank" rel="noopener"><i class="bi bi-twitter"></i></a><a href="https://www.linkedin.com/" aria-label="Linkedin" target="_blank" rel="noopener"><i class="bi bi-linkedin"></i></a></div></div><div class="tw-flex max-md:tw-flex-col tw-flex-wrap tw-gap-6 tw-h-full tw-w-full tw-justify-around"><div class="tw-flex tw-h-full tw-w-[200px] tw-flex-col tw-gap-4"><h2 class="tw-text-xl">Recursos</h2><div class="tw-flex tw-flex-col tw-gap-3"><a href="#" class="footer-link">Blog Financeiro</a><a href="#" class="footer-link">Simuladores</a><a href="#" class="footer-link">Glossário Financeiro</a><a href="#" class="footer-link">Status dos Serviços</a><a href="#" class="footer-link">Taxas e Tarifas</a></div></div><div class="tw-flex tw-h-full tw-w-[200px] tw-flex-col tw-gap-4"><h2 class="tw-text-xl">Fontara</h2><div class="tw-flex tw-flex-col tw-gap-3"><a href="#" class="footer-link">Sobre Nós</a><a href="#" class="footer-link">Carreiras</a><a href="#" class="footer-link">Imprensa</a><a href="#" class="footer-link">Fale Conosco</a><a href="#" class="footer-link">Compliance</a></div></div><div class="tw-flex tw-h-full tw-w-[200px] tw-flex-col tw-gap-4"><h2 class="tw-text-xl">Legal</h2><div class="tw-flex tw-flex-col tw-gap-3"><a href="#" class="footer-link">Termos de Uso</a><a href="#" class="footer-link">Política de Privacidade</a><a href="#" class="footer-link">Ouvidoria</a></div></div></div></div><hr class="tw-mt-8" /><div class="tw-mt-2 tw-flex tw-gap-2 tw-flex-col tw-text-gray-700 dark:tw-text-gray-300 tw-place-items-center tw-text-[12px] tw-w-full tw-text-center tw-place-content-around"><span>Copyright &#169; 2023-<span id="current-year"></span> Fontara Financial. Todos os direitos reservados.</span><span>Todas as marcas registradas e direitos autorais pertencem aos seus respectivos proprietários.</span></div>
    </footer>

    <div
      class="tw-hidden signing-modal-overlay" 
      id="signingModalOverlay" 
    >
      <div
        class="signing-modal-content"
        id="signingModalContent" 
      >
        <div class="modal-header-custom">
          <h3 id="modalTitle" class="modal-title-custom">Assinatura do Documento</h3>
          <button type="button" id="closeSigningModalBtn" class="close-modal-btn" title="Fechar">&times;</button>
        </div>
        <div id="docusign-view-container">
          {/* Docusign.js irá renderizar aqui OU o iframe será inserido aqui */}
        </div>
      </div>
    </div>

    <script>
      const DEFAULT_DOC_BASE64 = "JVBERi0xLjQKJeLjz9MKMSAwIG9iago8PAovVGl0bGUgKP7/KQovQ3JlYXRvciAo/v8pCi9Qcm9kdWNlciAo/v9Ta2lhL1BERiBtODgpCi9Nb2REYXRlIChEOjIwMjQwNTE2MTgwNzM0Wi0wMycGVJPT0JFigovQ3JlYXRpb25EYXRlIChEOjIwMjQwNTE2MTgwNzM0Wi0wMycGVJPT0JFigPjwvcGFnZWxhYmVsICgveHMxXCIpPj4KZW5kb2JqCjIgMCBvYmoKPDwKL1R5cGUgL0NhdGFsb2cKL1BhZ2VzIDMgMCBSCi9MYW5nIChwdC1CUikKL01ldGFkYXRhIDEgMCBSCj4+CmVuZG9iagozIDAgb2JqCjw8Ci9UeXBlIC9QYWdlcwovQ291bnQgMQovS2lkcyBbIDQgMCBSIF0KPj4KZW5kb2JqCjQgMCBvYmoKPDwKL1R5cGUgL1BhZ2UKL1BhcmVudCAzIDAgUgovUmVzb3VyY2VzIDw8Ci9Gb250IDw8Ci9GMSA1IDAgUgovUHJvY1NldCBbIC9QREYgL1RleHQgL0ltYWdlQiAvSW1hZ2VDIC9JbWFnZUkgXQo+PgovTWVkaWFCb3ggWyAwIDAgMjUwIDUwIF0KL0NvbnRlbnRzIDYgMCBSCi9Hcm91cCA8PAovVHlwZSAvR3JvdXAKL1MgL1RyYW5zcGFyZW5jeQovQ1MgL0RldmljZVJHQgovSSB0cnVlCj4+Ci9UYWJzIC9TCj4+CmVuZG9iago1IDAgb2JqCjw8Ci9UeXBlIC9Gb250Ci9TdWJ0eXBlIC9UeXBlMQovTmFtZSAvRjEKL0Jhc2VGb250IC9IZWx2ZXRpY2EKL0VuY29kaW5nIC9XaW5BbnNpRW5jb2RpbmcKPj4KZW5kb2JqCjYgMCBvYmoKPDwKL0xlbmd0aCAzNzE+PgpzdHJlYW0KMiAwIDAgMiAwIDAgbW92ZXRvCjAgMCAwIHJnYgpHCmJ0CjAuODYyNzQ1IDAuODYyNzQ1IDAuODYyNzQ1IHJnCmJ0CjkgMCBDb1NjYW4KL01lc3NhZ2VDb250ZW50ICgvU3BhY2UKMTIgMCAwIDEyIDEwIDUwIHRtCjQgMCAwIDQgMTIgMCAoKQpQUk9QZXJ0aWVzICgwKSAvQ1NTSW5mbzMwMSAvRkFBREFOIEhlbHZldGljYSAvQXBwbGljYWJsZSBUcnVlCi9Eb2N1bWVudElEIDEgMCBSCmFjY2Vzc2liaWxpdHkgL0ZvbnRTaXplIDEyKQpTdGFydExpbmVTZXQgdG9wbW9zdAovRjEgMTIgVGYKKCBTdGFydExpbmUpIFRKOwoyMCAwIHRkCi9GMSA1MiBUZgpodS9YIDAgMCAwIEZpcm1hIC9Tb2Z0TWFzayAvRjEgNTAgMCAxMSA4NSBwb3N0CmVuZFNldHRpbmdzCjEgMCAwIDEgMCAwIHBvc3Rtb2RlL1NwYWNlCjI1MC4wMCA1MC4wMCByZWN0CnQgcG9wCiBTcGFjZSAvU3BhY2UKCiAgQmFzZUZvbnRGYW1pbHkgKEhlbHZldGljYSkKICBDYWNoZUNvbXBsZXRlZCAodHJ1ZSkKICBEZWNvZGVGb3JtYXQgKHRydWUpCiAgRGlzcGxheSAoZmFsc2UpCiAgRW5jb2RpbmdTY2hlbWUgKEFkb2JlU3RhbmRhcmRFbmNvZGluZykKICBGb250RmlsbGluZ1ggMC4wMAogIEZvbnRNYXRyaXggWzEgMCAwIDEgMCAwIF0KICBGb250UmV2aXNpb24gMC4wMAogIEZvbnRTdGFja0hlaWdodCA1MC4wMAogIEZvbnRJZCAxCmVuZG9iagoNCjEgMCAwIDEgMCAwIGNtCmJ0CjIwIDM1IHRkCjAuMCAwLjAgMC4wIHJnCigtIDEtKSBUagplVAplbmRzdHJlYW0KZW5kb2JqCnhyZWYKMCA3CjAwMDAwMDAwMDAgNjU1MzUgZiAKMDAwMDAwMDAxNSAwMDAwMCBuIAowMDAwMDAwMTgzIDAwMDAwIG4gCjAwMDAwMDAyNjAgMDAwMDAgbiAKMDAwMDAwMDMyNSAwMDAwMCBuIAowMDAwMDAwNTEzIDAwMDAwIG4gCjAwMDAwMDA2MDYgMDAwMDAgbiAKdHJhaWxlcgo8PAovU2l6ZSA3Ci9Sb290IDIgMCBSCi9JbmZvIDEgMCBSCj4+CnN0YXJ0eHJlZgo5ODUKJSVFT0YK";
      const DEFAULT_DOC_NAME = "ContratoPadraoFontara.pdf";
      const DEFAULT_DOC_ID = "1";
      const DOCUSIGN_JS_CLIENT_ID = "f0197e49-8018-439d-88a4-996635a6044d"; // Sua Chave de Integração (IK)
      const DOCUSIGN_JS_ENVIRONMENT = "demo"; // 'demo' para sandbox, 'prod' para produção

      document.addEventListener('DOMContentLoaded', function() {
        const yearSpan = document.getElementById('current-year');
        if (yearSpan) yearSpan.textContent = new Date().getFullYear();

        const envelopeForm = document.getElementById('envelopeForm');
        const useDefaultDocRadio = document.getElementById('useDefaultDoc');
        const useUploadedDocRadio = document.getElementById('useUploadedDoc');
        const fileUploadContainer = document.getElementById('fileUploadContainer');
        const uploadedDocInput = document.getElementById('uploadedDoc');
        const submitEnvelopeBtn = document.getElementById('submitEnvelopeBtn');
        
        const signingModalOverlay = document.getElementById('signingModalOverlay');
        const closeSigningModalBtn = document.getElementById('closeSigningModalBtn');
        const docusignViewContainer = document.getElementById('docusign-view-container'); // Para Docusign.js ou Iframe
        const mainHeader = document.getElementById('mainHeader'); 
        let originalHeaderZIndex = ''; 
        
        // Defina a origem esperada do Docusign para o seu ambiente
        const docusignExpectedOrigin = DOCUSIGN_JS_ENVIRONMENT === "demo" ? "https://demo.docusign.net" : "https://{seu_dominio_prod}.docusign.net";


        function showFileUpload(show) {
          if (fileUploadContainer && uploadedDocInput) {
            if (show) {
              fileUploadContainer.classList.remove('tw-hidden');
              uploadedDocInput.required = true;
            } else {
              fileUploadContainer.classList.add('tw-hidden');
              uploadedDocInput.required = false;
              uploadedDocInput.value = '';
            }
          }
        }

        if(useDefaultDocRadio) useDefaultDocRadio.addEventListener('change', () => showFileUpload(false));
        if(useUploadedDocRadio) useUploadedDocRadio.addEventListener('change', () => showFileUpload(true));
        if(useDefaultDocRadio && useDefaultDocRadio.checked) showFileUpload(false);
        else if (useUploadedDocRadio && useUploadedDocRadio.checked) showFileUpload(true);


        function openSigningModal() {
            if (signingModalOverlay) {
                signingModalOverlay.classList.remove('tw-hidden');
                document.body.classList.add('modal-open');
                if (mainHeader) {
                    originalHeaderZIndex = mainHeader.style.zIndex; 
                    mainHeader.style.zIndex = '10'; 
                }
            }
        }

        function closeSigningModal() {
            if (signingModalOverlay) {
                signingModalOverlay.classList.add('tw-hidden');
                document.body.classList.remove('modal-open');
                if (mainHeader) {
                    mainHeader.style.zIndex = originalHeaderZIndex || ''; 
                }
                // Limpa o container do Docusign.js/iframe para a próxima vez
                if(docusignViewContainer) docusignViewContainer.innerHTML = ''; 
            }
        }
        
        if(closeSigningModalBtn) closeSigningModalBtn.addEventListener('click', closeSigningModal);
        if (signingModalOverlay) {
            signingModalOverlay.addEventListener('click', function(event) {
                if (event.target === signingModalOverlay) closeSigningModal();
            });
        }

        function handleDocusignJsEvents(eventData, envelopeId, signerName) {
            console.log(`[Docusign.js Event] ${eventData.type}`, eventData);
            const returnUrlBase = `${window.location.origin}/agradecimento/obrigado.html?recipientName=${encodeURIComponent(signerName)}&envelopeId=${envelopeId}`;

            switch (eventData.type) {
                case 'SIGNING_COMPLETE':
                case 'FINISH': // Evento comum para conclusão geral
                    closeSigningModal();
                    window.location.href = `${returnUrlBase}&event=signing_complete`;
                    break;
                case 'CLOSE': // Usuário fechou o X da UI do Docusign
                case 'CANCEL':
                case 'DECLINE':
                case 'SESSION_TIMEOUT':
                case 'TTL_EXPIRED':
                    closeSigningModal();
                    window.location.href = `${returnUrlBase}&event=${eventData.type.toLowerCase()}`;
                    break;
                case 'ERROR':
                    console.error("Erro na cerimônia Docusign.js:", eventData.data);
                    closeSigningModal();
                    alert(`Ocorreu um erro na assinatura Docusign: ${eventData.data.error || 'Erro desconhecido'}`);
                    break;
            }
        }
        
        // Listener para postMessage (ainda útil como fallback ou se Docusign.js não for usado)
        function handleLegacyDocusignMessage(event) {
            if (event.origin !== docusignExpectedOrigin && !docusignExpectedOrigin.includes(new URL(event.origin).host) ) { // Verifica subdomínios
                return;
            }
            if (typeof event.data === 'string' && event.data.startsWith('event=')) {
                const params = new URLSearchParams(event.data);
                const docusignEvent = params.get('event');
                // Esta lógica só será acionada se o Docusign.js falhar em capturar e o iframe redirecionar
                console.log(`[Legacy postMessage] Evento Docusign recebido: ${docusignEvent}`);
                if (['signing_complete', 'decline', 'cancel', 'session_timeout', 'ttl_expired'].includes(docusignEvent)) {
                    closeSigningModal(); 
                    // Redirecionamento já tratado pelo Docusign.js ou returnUrl do iframe
                }
            }
        }
        window.addEventListener('message', handleLegacyDocusignMessage, false);


        if(envelopeForm) {
            envelopeForm.addEventListener('submit', async function(event) {
              event.preventDefault();
              const originalButtonInnerHTML = submitEnvelopeBtn.innerHTML;
              if(submitEnvelopeBtn) {
                submitEnvelopeBtn.disabled = true;
                submitEnvelopeBtn.innerHTML = '<div class="spinner-small"></div> Processando...';
              }

              const signerName = document.getElementById('signerName').value;
              const signerEmail = document.getElementById('signerEmail').value;
              const emailSubject = document.getElementById('emailSubject').value;
              const useDefault = useDefaultDocRadio.checked;
              
              const selectedExperience = document.querySelector('input[name="signingExperience"]:checked').value;
              const useFocused = selectedExperience === 'focused';
              const requireClickAgree = selectedExperience === 'click_to_agree';

              let documentBase64 = '';
              let documentName = '';
              const documentFileExtension = 'pdf'; 
              const documentId = DEFAULT_DOC_ID; 

              try {
                if (useDefault) {
                  documentBase64 = DEFAULT_DOC_BASE64;
                  documentName = DEFAULT_DOC_NAME;
                  if (!documentBase64) throw new Error("Documento padrão não configurado.");
                } else {
                  const file = uploadedDocInput.files[0];
                  if (!file) throw new Error("Por favor, selecione um arquivo PDF.");
                  if (file.type !== "application/pdf") throw new Error("Apenas arquivos PDF são permitidos.");
                  documentName = file.name;
                  documentBase64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                  });
                }

                const clientUserId = `fontara_${signerEmail.replace(/[^a-zA-Z0-9]/g, "")}_${Date.now()}`; 

                const envelopePayload = {
                  emailSubject: emailSubject,
                  documents: [{ name: documentName, fileExtension: documentFileExtension, documentId: documentId, documentBase64: documentBase64 }],
                  recipients: {
                    signers: [{
                      email: signerEmail, name: signerName, recipientId: "1", 
                      clientUserId: clientUserId, routingOrder: "1",
                      tabs: { signHereTabs: [{ anchorString: "\\s1\\", anchorXOffset: "0", anchorYOffset: "10", anchorUnits: "pixels" }] }
                    }]
                  },
                  status: "sent"
                };

                if (requireClickAgree) {
                    // LÓGICA PARA MODIFICAR O ENVELOPE E ADICIONAR TERMOS DE ACEITE
                    // Exemplo: Adicionar um documento suplementar ou uma aba de checkbox obrigatória
                    // Esta parte é um placeholder e precisa ser implementada conforme sua necessidade.
                    // Se for uma aba de checkbox, você adicionaria a `tabs.checkboxTabs` no signatário:
                    // envelopePayload.recipients.signers[0].tabs.checkboxTabs = [
                    //   { documentId: "1", pageNumber: "1", anchorString: "\\agreeTerms\\", required: "true", tabLabel: "AgreeToTerms" }
                    // ];
                    // E seu documento precisaria da âncora \\agreeTerms\\
                    console.warn("Funcionalidade 'Exigir Clique para Concordar' (modificando envelope) não totalmente implementada neste exemplo de frontend. Configuração de abas/documentos deve ser feita no payload do envelope.");
                    // Por enquanto, o Docusign.js pode ter uma opção para exibir termos simples:
                }

                let response = await fetch('/.netlify/functions/docusign-actions', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ action: "CREATE_DYNAMIC_EMBEDDED_ENVELOPE", payload: envelopePayload })
                });
                if (!response.ok) {
                  const errorData = await response.json().catch(() => ({ error: `Erro HTTP ${response.status}: ${response.statusText}` }));
                  throw new Error(errorData.error || `Falha ao criar envelope.`);
                }
                const envelopeResult = await response.json();
                const envelopeId = envelopeResult.envelopeId;
                if (!envelopeId) throw new Error("ID do envelope não retornado.");
                
                const recipientViewPayload = {
                  envelopeId: envelopeId, signerEmail: signerEmail, signerName: signerName,
                  clientUserId: clientUserId,
                  returnUrl: `${window.location.origin}/agradecimento/obrigado.html?recipientName=${encodeURIComponent(signerName)}&event=FALLBACK_IFRAME_REDIRECT&envelopeId=${envelopeId}`,
                  // A opção useFocusedView (para chromeControls) será usada pelo Docusign.js no frontend se ele for escolhido.
                  // Para a Experiência Clássica, podemos ainda enviar para a função backend.
                  useFocusedView: (selectedExperience === 'classic' && useFocused) ? useFocused : undefined 
                };

                response = await fetch('/.netlify/functions/docusign-actions', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ action: "GET_EMBEDDED_SIGNING_URL", payload: recipientViewPayload })
                });
                if (!response.ok) {
                  const errorData = await response.json().catch(() => ({ error: `Erro HTTP ${response.status}: ${response.statusText}` }));
                  throw new Error(errorData.error || `Falha ao obter URL de assinatura.`);
                }
                const signingResult = await response.json();
                const signingUrl = signingResult.signingUrl;

                if (signingUrl) {
                  openSigningModal(); // Abre o modal genérico
                  docusignViewContainer.innerHTML = ''; // Limpa o container

                  if (selectedExperience === 'classic') {
                    // Carrega no iframe para experiência clássica
                    const iframe = document.createElement('iframe');
                    iframe.src = signingUrl; // A URL já pode ter sido ajustada para focused view pela função backend
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    iframe.style.border = 'none';
                    docusignViewContainer.appendChild(iframe);
                  } else {
                    // Usa Docusign.js para focused ou click-to-agree
                    window.DocuSign.loadDocuSign(DOCUSIGN_JS_CLIENT_ID)
                      .then((docusignSdk) => {
                        const sdkConfig = {
                            displayFormat: useFocused ? 'focused' : 'lucid', // 'focused' ou 'lucid'
                            style: { /* ... suas personalizações ... */ },
                            // Para "Click to Agree" com Docusign.js:
                            // Você pode precisar configurar termos aqui ou garantir que o envelope
                            // já os contenha como um documento suplementar que requer aceite.
                            // Exemplo para termos simples exibidos pelo Docusign.js:
                            // termsOfService: requireClickAgree ? [
                            //    { type: "modal", documentName: "Termos de Uso Fontara", text: "Eu concordo com os termos e condições..." }
                            // ] : []
                        };
                        if (requireClickAgree) {
                            // Placeholder para lógica de Click to Agree com Docusign.js
                            // Você pode precisar de um documento suplementar no envelope ou
                            // usar a funcionalidade de termos do Docusign.js se ela atender.
                            // Exemplo:
                            sdkConfig.termsOfService = [
                                {
                                    type: "modal", // ou 'inline'
                                    documentName: "Termos Adicionais Fontara",
                                    text: "Ao prosseguir, você concorda com os Termos Adicionais da Fontara Financial. [Link para os termos completos, se necessário]",
                                    button: { text: "Eu Concordo", style: "primary" } // Estilo do botão de aceite
                                }
                            ];
                            // Se os termos já estão no envelope e precisam de uma aba de aceite,
                            // a configuração do envelope já deve ter cuidado disso.
                            // O Docusign.js também pode ter opções para 'supplementalDocuments' se eles
                            // fazem parte do envelope e precisam ser apresentados de forma específica.
                        }

                        const signingExperience = docusignSdk.signing(sdkConfig);
                        
                        signingExperience.on('ready', (data) => console.log('Docusign.js: Pronto', data));
                        signingExperience.on('sessionEnd', (data) => { // Evento genérico para fim de sessão
                            console.log('Docusign.js: Sessão Encerrada', data);
                            handleDocusignJsEvents(data, envelopeId, signerName);
                        });
                        // Outros eventos específicos como 'complete', 'cancel', 'decline' podem ser redundantes
                        // se 'sessionEnd' cobrir todos os cenários de finalização. Verifique a documentação do Docusign.js.

                        signingExperience.mount(signingUrl, '#docusign-view-container')
                          .catch(error => {
                             console.error("Erro ao montar Docusign.js:", error);
                             closeSigningModal();
                             alert("Falha ao iniciar a experiência de assinatura Docusign.");
                          });
                      })
                      .catch((ex) => {
                        console.error("Erro ao carregar Docusign.js SDK:", ex);
                        closeSigningModal();
                        alert("Não foi possível carregar o componente de assinatura Docusign.");
                      });
                  }
                } else {
                  throw new Error("URL de assinatura não retornada.");
                }
              } catch (error) {
                console.error("Erro no processo Docusign:", error);
                alert(`Ocorreu um erro: ${error.message}`);
              } finally {
                if(submitEnvelopeBtn) {
                    submitEnvelopeBtn.disabled = false;
                    submitEnvelopeBtn.innerHTML = originalButtonInnerHTML; 
                }
              }
            });
        }
      });
    </script>
    <script src="./scripts/components.js"></script>
    <script src="./scripts/index.js"></script>
  </body>
</html>
