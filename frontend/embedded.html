<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assinatura Embarcada - Fontara Financial</title>
    <meta
      name="description"
      content="Assine documentos digitalmente com diferentes experiências Docusign."
    />
    <link rel="shortcut icon" href="./assets/logo/logo.png" type="image/x-icon" />
    <link rel="stylesheet" href="./css/tailwind-build.css" />
    <link rel="stylesheet" href="./css/index.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css"
    />
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.js"></script>
    <script src="https://js-d.docusign.com/bundle.js"></script>

    <style>
      body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        background-color: #f9fafb; /* Tailwind gray-50 */
      }
      html.tw-dark body {
         background-color: #1f2937; /* Tailwind gray-800 */
      }
      main {
        flex-grow: 1;
      }
      .form-input-custom {
        @apply tw-block tw-w-full tw-px-4 tw-py-3 tw-border tw-border-black dark:tw-border-gray-500 tw-bg-gray-100 dark:tw-bg-gray-700 tw-rounded-md tw-shadow-sm focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-indigo-500 focus:tw-border-indigo-500 dark:tw-text-white tw-text-base;
        min-height: 50px;
      }
      .form-label {
        @apply tw-block tw-mb-2 tw-text-sm tw-font-medium tw-text-gray-900 dark:tw-text-gray-300;
      }
      .form-radio {
        @apply tw-w-4 tw-h-4 tw-text-indigo-600 tw-bg-gray-100 tw-border-gray-300 focus:tw-ring-indigo-500 dark:focus:tw-ring-indigo-600 dark:tw-ring-offset-gray-800 focus:tw-ring-2 dark:tw-bg-gray-700 dark:tw-border-gray-600;
      }
    </style>
  </head>
  <body>
    <div id="header-placeholder"></div>

    <main class="tw-container tw-mx-auto tw-p-4 tw-pt-24">
      <h1 class="tw-text-3xl tw-font-bold tw-mb-6 tw-text-center dark:tw-text-white">
        Assinatura Embarcada via Docusign.js SDK
      </h1>
      <div class="tw-max-w-2xl tw-mx-auto tw-bg-white dark:tw-bg-gray-900 tw-p-8 tw-rounded-lg tw-shadow-lg">
        <form id="signingForm" class="tw-space-y-6">
            <div>
                <label for="signerEmail" class="form-label">Email do Signatário:</label>
                <input type="email" id="signerEmail" name="signerEmail" class="form-input-custom" required value="teste@gmail.com">
            </div>
            <div>
                <label for="signerName" class="form-label">Nome do Signatário:</label>
                <input type="text" id="signerName" name="signerName" class="form-input-custom" required value="Nome Teste">
            </div>
            <div>
                <label for="signerCountryCode" class="form-label">Código do País (Telefone):</label>
                <input type="text" id="signerCountryCode" name="signerCountryCode" class="form-input-custom" value="+55">
            </div>
            <div>
                <label for="signerPhoneNumber" class="form-label">Número do Telefone:</label>
                <input type="text" id="signerPhoneNumber" name="signerPhoneNumber" class="form-input-custom" value="11999999999">
            </div>
             <div>
                <label for="signerDocType" class="form-label">Tipo de Documento:</label>
                <input type="text" id="signerDocType" name="signerDocType" class="form-input-custom" value="CPF">
            </div>
            <div>
                <label for="signerDocNumber" class="form-label">Número do Documento:</label>
                <input type="text" id="signerDocNumber" name="signerDocNumber" class="form-input-custom" value="12345678900">
            </div>
            <div>
                <label for="signerAddress" class="form-label">Endereço Completo:</label>
                <input type="text" id="signerAddress" name="signerAddress" class="form-input-custom" value="Rua Exemplo, 123, Bairro, Cidade - UF, 00000-000">
            </div>
            <fieldset class="tw-space-y-2">
                <legend class="form-label">Escolha a experiência de assinatura:</legend>
                <div>
                    <input type="radio" id="experienceIframe" name="signingExperience" value="IFRAME" class="form-radio" checked>
                    <label for="experienceIframe" class="tw-ml-2 dark:tw-text-gray-300">iFrame na Página</label>
                </div>
                <div>
                    <input type="radio" id="experiencePopup" name="signingExperience" value="POPUP" class="form-radio">
                    <label for="experiencePopup" class="tw-ml-2 dark:tw-text-gray-300">Popup</label>
                </div>
                <div>
                    <input type="radio" id="experienceFocusMode" name="signingExperience" value="FOCUS_MODE_EMBED" class="form-radio">
                    <label for="experienceFocusMode" class="tw-ml-2 dark:tw-text-gray-300">Modo Focado (Embed)</label>
                </div>
            </fieldset>
            <button type="submit" id="submitEnvelopeBtn" class="btn tw-w-full">
                Iniciar Assinatura
            </button>
        </form>
      </div>
      <div id="docusign-modal" class="tw-fixed tw-inset-0 tw-bg-gray-900 tw-bg-opacity-75 tw-flex tw-items-center tw-justify-center tw-hidden tw-z-50">
        <div class="tw-bg-white dark:tw-bg-gray-800 tw-p-4 tw-rounded-lg tw-shadow-xl tw-w-11/12 tw-h-5/6 md:tw-w-3/4 md:tw-h-5/6 tw-relative">
          <button id="close-modal-btn" class="tw-absolute tw-top-2 tw-right-2 tw-text-gray-600 dark:tw-text-gray-300 hover:tw-text-gray-900 dark:hover:tw-text-white">
            <i class="bi bi-x-lg tw-text-2xl"></i>
          </button>
          <div id="docusign-embed-container" class="tw-w-full tw-h-full"></div>
        </div>
      </div>
    </main>

    <div id="footer-placeholder"></div>

    <script src="./scripts/index.js"></script>
    <script src="./scripts/loadPartials.js" defer></script> 

    <script>
      function initializePageSpecificScripts() {
        console.log("embedded.html: initializePageSpecificScripts chamada.");
        const form = document.getElementById('signingForm');
        const submitEnvelopeBtn = document.getElementById('submitEnvelopeBtn');
        const docusignModal = document.getElementById('docusign-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const embedContainer = document.getElementById('docusign-embed-container');

        if(closeModalBtn) {
            closeModalBtn.addEventListener('click', () => {
                if(docusignModal) docusignModal.classList.add('tw-hidden');
                if(embedContainer) embedContainer.innerHTML = '';
            });
        }
        
        function openSigningModal() {
            if(docusignModal) docusignModal.classList.remove('tw-hidden');
        }

        function closeSigningModal() {
            if(docusignModal) docusignModal.classList.add('tw-hidden');
            if(embedContainer) embedContainer.innerHTML = '';
        }

        if (form && submitEnvelopeBtn) {
          form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const originalButtonInnerHTML = submitEnvelopeBtn.innerHTML;
            submitEnvelopeBtn.disabled = true;
            submitEnvelopeBtn.innerHTML = '<span class="tw-animate-pulse">Processando...</span>';

            const formData = new FormData(form);
            const payload = {
              signerEmail: formData.get('signerEmail'),
              signerName: formData.get('signerName'),
              status: 'sent',
              signerCountryCode: formData.get('signerCountryCode'),
              signerPhoneNumber: formData.get('signerPhoneNumber'),
              signerDocType: formData.get('signerDocType'),
              signerDocNumber: formData.get('signerDocNumber'),
              signerAddress: formData.get('signerAddress')
            };
            const selectedExperience = document.querySelector('input[name="signingExperience"]:checked').value;

            try {
              let response = await fetch('/.netlify/functions/docusign-actions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: "CREATE_ENVELOPE_FROM_TEMPLATE_RECIPIENT_PROVIDED", payload })
              });

              if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: `Erro HTTP ${response.status}` }));
                throw new Error(errorData.error || `Falha ao criar envelope.`);
              }
              const envelopeResult = await response.json();
              const envelopeId = envelopeResult.envelopeId;

              const recipientViewPayload = {
                envelopeId: envelopeId,
                recipientEmail: payload.signerEmail,
                recipientName: payload.signerName,
                returnUrl: window.location.origin + '/callback.html?event=signing_complete&envelopeId=' + envelopeId,
                authenticationMethod: 'None'
              };

              response = await fetch('/.netlify/functions/docusign-actions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: "GET_EMBEDDED_SIGNING_URL", payload: recipientViewPayload })
              });

              if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: `Erro HTTP ${response.status}` }));
                throw new Error(errorData.error || `Falha ao obter URL de assinatura.`);
              }
              const signingResult = await response.json();
              const signingUrl = signingResult.signingUrl;

              if (signingUrl && window.DocuSign && typeof window.DocuSign.loadDocuSign === 'function') {
                  const DOCUSIGN_IK = "SEU_DOCUSIGN_INTEGRATION_KEY_AQUI"; // SUBSTITUA

                  window.DocuSign.loadDocuSign(DOCUSIGN_IK)
                    .then((docusign) => {
                      embedContainer.innerHTML = ''; 
                      const signingExperience = docusign.signing({
                          url: signingUrl,
                          displayFormat: selectedExperience,
                          source: "WEB",
                          container: selectedExperience !== 'POPUP' ? embedContainer : undefined,
                          style: { modal: { backdrop: "rgba(0,0,0,0.7)" } }
                      });
                      if (selectedExperience !== 'POPUP') {
                          openSigningModal();
                          signingExperience.mount(embedContainer);
                      }
                      signingExperience.on('sessionEnd', (event) => {
                          console.log("DocuSign Session End:", event);
                          closeSigningModal();
                          alert(`Evento de assinatura: ${event.type}`);
                          if (event.type === 'SIGNING_COMPLETE') {
                              // Ação pós assinatura
                          }
                      });
                    })
                    .catch((ex) => {
                      console.error(`Erro ao carregar Docusign.js SDK: ${ex.message}`, ex);
                      closeSigningModal();
                      alert("Não foi possível carregar o componente de assinatura Docusign (SDK).");
                    });
              } else { 
                if (!signingUrl) throw new Error("URL de assinatura não retornada.");
                if (!(window.DocuSign && typeof window.DocuSign.loadDocuSign === 'function')) {
                     console.error("DocuSign JS SDK não carregado ou loadDocuSign não é uma função.");
                     alert("SDK do DocuSign não está pronto.");
                }
              }
            } catch (error) {
              console.error("Erro no processo Docusign:", error);
              alert(`Ocorreu um erro: ${error.message}`);
            } finally {
              if(submitEnvelopeBtn) {
                  submitEnvelopeBtn.disabled = false;
                  submitEnvelopeBtn.innerHTML = originalButtonInnerHTML;
              }
            }
          });
        }
      }
      window.initializePageSpecificScripts = initializePageSpecificScripts;
    </script>
  </body>
</html>
