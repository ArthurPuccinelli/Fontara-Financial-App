<!DOCTYPE html>
<html lang="pt-BR" class="tw-dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assinatura Embarcada - Fontara Financial</title>
    <meta
      name="description"
      content="Assine documentos digitalmente com diferentes experiências Docusign."
    />
    <link rel="shortcut icon" href="./assets/logo/logo.png" type="image/x-icon" />
    <link rel="stylesheet" href="./css/tailwind-build.css" />
    <link rel="stylesheet" href="./css/index.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css"
    />
    <script src="https://js-d.docusign.com/bundle.js"></script>

    <style>
      /* Seus estilos para .form-input-custom, .form-label, .form-radio, etc. e para o modal permanecem aqui */
      .form-input-custom {
        @apply tw-block tw-w-full tw-px-4 tw-py-3 tw-border tw-border-black dark:tw-border-gray-500 tw-bg-gray-100 dark:tw-bg-gray-700 tw-rounded-md tw-shadow-sm focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-indigo-500 focus:tw-border-indigo-500 dark:tw-text-white tw-text-base;
        min-height: 50px; 
      }
      .form-label {
        @apply tw-block tw-text-base tw-font-medium tw-text-gray-700 dark:tw-text-gray-300 tw-mb-2; 
      }
      .form-radio { 
        @apply tw-h-5 tw-w-5 tw-text-indigo-600 tw-border-gray-300 dark:tw-border-gray-600 focus:tw-ring-indigo-500 dark:tw-bg-gray-700 dark:focus:tw-ring-offset-gray-800 tw-rounded-full;
      }
      .form-choice-label { 
        @apply tw-ml-3 tw-block tw-text-base tw-font-medium tw-text-gray-700 dark:tw-text-gray-300 tw-cursor-pointer;
      }
       .spinner-small {
        border: 3px solid #f3f3f3; border-top: 3px solid white; 
        border-radius: 50%; width: 20px; height: 20px;
        animation: spin 1s linear infinite; display: inline-block; margin-right: 0.5rem;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      .signing-modal-overlay {
        position: fixed; inset: 0;
        background-color: rgba(0,0,0,0.85);
        z-index: 5000 !important; 
        display: none; 
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }
      .signing-modal-overlay.active { display: flex; }
      .signing-modal-content {
        background-color: #fff; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        width: 90vw; height: 90vh; max-width: 1000px; 
        display: flex; flex-direction: column; overflow: hidden;
        position: relative; z-index: 5001 !important;
      }
      .dark .signing-modal-content { background-color: #1f2937; }
      .modal-header-custom {
        padding: 0.75rem 1rem; background-color: #f3f4f6; 
        border-bottom: 1px solid #e5e7eb; display: flex;
        justify-content: space-between; align-items: center; flex-shrink: 0;
      }
      .dark .modal-header-custom { background-color: #374151; border-color: #4b5563; }
      .modal-title-custom { font-size: 1.1rem; font-weight: 600; }
      .close-modal-btn { font-size: 1.5rem; background:none; border:none; cursor:pointer; color: #6b7280; }
      .dark .close-modal-btn { color: #9ca3af; }
      #docusign-view-container { flex-grow: 1; width: 100%; height: calc(100% - 50px); background-color: #fff; }
      .dark #docusign-view-container { background-color: #1f2937; }
      #docusign-classic-iframe { width: 100%; height: 100%; border: none; }
    </style>
  </head>
  <body class="tw-flex tw-min-h-[100vh] tw-flex-col tw-bg-[#fcfcfc] tw-text-black dark:tw-bg-black dark:tw-text-white">
    
    <div id="header-placeholder">
        </div>

    <main class="tw-mt-20 tw-pt-10 tw-pb-10 tw-px-4 sm:tw-px-[5%] lg:tw-px-[10%]">
      <div class="tw-mx-auto tw-w-full lg:tw-max-w-5xl"> 
        <h1 class="tw-text-3xl md:tw-text-4xl tw-font-semibold tw-text-center tw-mb-8">Assinatura Embarcada</h1>
        
        <form id="envelopeForm" class="tw-w-full tw-space-y-6 tw-bg-white dark:tw-bg-gray-800 tw-p-6 md:tw-p-8 tw-rounded-lg tw-shadow-xl">
          <div>
            <label for="signerName" class="form-label">Seu Nome Completo:</label>
            <input type="text" name="signerName" id="signerName" required class="form-input-custom" placeholder="Ex: João da Silva">
          </div>
          <div>
            <label for="signerEmail" class="form-label">Seu E-mail:</label>
            <input type="email" name="signerEmail" id="signerEmail" required class="form-input-custom" placeholder="Ex: joao.silva@email.com">
          </div>
          <div>
            <label for="emailSubject" class="form-label">Assunto do Documento:</label>
            <input type="text" name="emailSubject" id="emailSubject" required class="form-input-custom" value="Documento Fontara Financial para Assinatura">
          </div>

          <fieldset class="tw-pt-4">
            <legend class="form-label tw-mb-3">Escolha o Documento:</legend>
            <div class="tw-flex tw-items-center tw-mb-3">
              <input id="useDefaultDoc" name="documentChoice" type="radio" value="default" checked class="form-radio">
              <label for="useDefaultDoc" class="form-choice-label">Usar Contrato Padrão Fontara</label>
            </div>
            <div class="tw-flex tw-items-center">
              <input id="useUploadedDoc" name="documentChoice" type="radio" value="upload" class="form-radio">
              <label for="useUploadedDoc" class="form-choice-label">Enviar meu próprio documento (PDF)</label>
            </div>
          </fieldset>
          
          <div id="fileUploadContainer" class="tw-hidden"> 
            <label for="uploadedDoc" class="form-label">Selecione o arquivo PDF:</label>
            <input type="file" name="uploadedDoc" id="uploadedDoc" class="form-input-custom" accept=".pdf">
            <p class="tw-mt-1 tw-text-xs tw-text-gray-500 dark:tw-text-gray-400">O documento deve conter a âncora `\s1\` para assinatura.</p>
          </div>

          <fieldset class="tw-pt-4">
            <legend class="form-label tw-mb-3">Opções de Experiência de Assinatura:</legend>
            <div class="tw-space-y-3">
                <div class="tw-flex tw-items-center">
                  <input type="radio" id="expClassic" name="signingExperience" value="classic" checked class="form-radio">
                  <label for="expClassic" class="form-choice-label">Experiência Clássica (Iframe)</label>
                </div>
                <div class="tw-flex tw-items-center">
                  <input type="radio" id="expFocused" name="signingExperience" value="focused" class="form-radio">
                  <label for="expFocused" class="form-choice-label">Visualização Focada (Docusign.js)</label>
                </div>
                <div class="tw-flex tw-items-center">
                  <input type="radio" id="expClickToAgree" name="signingExperience" value="click_to_agree" class="form-radio">
                  <label for="expClickToAgree" class="form-choice-label">Apresentar Termos para Aceite (Docusign.js)</label>
                </div>
            </div>
          </fieldset>

          <div class="tw-pt-4">
            <button type="submit" id="submitEnvelopeBtn" class="btn tw-w-full tw-flex tw-justify-center tw-items-center tw-py-3 tw-px-4 tw-text-lg">
              <i class="bi bi-pencil-square tw-mr-2"></i><span id="submitBtnText">Assinar</span>
            </button>
          </div>
        </form>
      </div>
    </main>

    <div id="footer-placeholder">
        </div>

    <div class="signing-modal-overlay" id="signingModalOverlay">
      <div class="signing-modal-content" id="signingModalContent">
        <div class="modal-header-custom">
          <h3 id="modalTitle" class="modal-title-custom">Assinatura do Documento</h3>
          <button type="button" id="closeSigningModalBtn" class="close-modal-btn" title="Fechar">&times;</button>
        </div>
        <div id="docusign-view-container">
          {/* Docusign.js ou Iframe será renderizado aqui */}
        </div>
      </div>
    </div>

    <script>
      // CONSTANTES E LÓGICA DO FORMULÁRIO (como na sua última versão)
      const DEFAULT_DOC_BASE64 = "JVBERi0xLjQKJeLjz9MKMSAwIG9iago8PAovVGl0bGUgKP7/KQovQ3JlYXRvciAo/v8pCi9Qcm9kdWNlciAo/v9Ta2lhL1BERiBtODgpCi9Nb2REYXRlIChEOjIwMjQwNTE2MTgwNzM0Wi0wMycGVJPT0JFigovQ3JlYXRpb25EYXRlIChEOjIwMjQwNTE2MTgwNzM0Wi0wMycGVJPT0JFigPjwvcGFnZWxhYmVsICgveHMxXCIpPj4KZW5kb2JqCjIgMCBvYmoKPDwKL1R5cGUgL0NhdGFsb2cKL1BhZ2VzIDMgMCBSCi9MYW5nIChwdC1CUikKL01ldGFkYXRhIDEgMCBSCj4+CmVuZG9iagozIDAgb2JqCjw8Ci9UeXBlIC9QYWdlcwovQ291bnQgMQovS2lkcyBbIDQgMCBSIF0KPj4KZW5kb2JqCjQgMCBvYmoKPDwKL1R5cGUgL1BhZ2UKL1BhcmVudCAzIDAgUgovUmVzb3VyY2VzIDw8Ci9Gb250IDw8Ci9GMSA1IDAgUgovUHJvY1NldCBbIC9QREYgL1RleHQgL0ltYWdlQiAvSW1hZ2VDIC9JbWFnZUkgXQo+PgovTWVkaWFCb3ggWyAwIDAgMjUwIDUwIF0KL0NvbnRlbnRzIDYgMCBSCi9Hcm91cCA8PAovVHlwZSAvR3JvdXAKL1MgL1RyYW5zcGFyZW5jeQovQ1MgL0RldmljZVJHQgovSSB0cnVlCj4+Ci9UYWJzIC9TCj4+CmVuZG9iago1IDAgb2JqCjw8Ci9UeXBlIC9Gb250Ci9TdWJ0eXBlIC9UeXBlMQovTmFtZSAvRjEKL0Jhc2VGb250IC9IZWx2ZXRpY2EKL0VuY29kaW5nIC9XaW5BbnNpRW5jb2RpbmcKPj4KZW5kb2JqCjYgMCBvYmoKPDwKL0xlbmd0aCAzNzE+PgpzdHJlYW0KMiAwIDAgMiAwIDAgbW92ZXRvCjAgMCAwIHJnYgpHCmJ0CjAuODYyNzQ1IDAuODYyNzQ1IDAuODYyNzQ1IHJnCmJ0CjkgMCBDb1NjYW4KL01lc3NhZ2VDb250ZW50ICgvU3BhY2UKMTIgMCAwIDEyIDEwIDUwIHRtCjQgMCAwIDQgMTIgMCAoKQpQUk9QZXJ0aWVzICgwKSAvQ1NTSW5mbzMwMSAvRkFBREFOIEhlbHZldGljYSAvQXBwbGljYWJsZSBUcnVlCi9Eb2N1bWVudElEIDEgMCBSCmFjY2Vzc2liaWxpdHkgL0ZvbnRTaXplIDEyKQpTdGFydExpbmVTZXQgdG9wbW9zdAovRjEgMTIgVGYKKCBTdGFydExpbmUpIFRKOwoyMCAwIHRkCi9GMSA1MiBUZgpodS9YIDAgMCAwIEZpcm1hIC9Tb2Z0TWFzayAvRjEgNTAgMCAxMSA4NSBwb3N0CmVuZFNldHRpbmdzCjEgMCAwIDEgMCAwIHBvc3Rtb2RlL1NwYWNlCjI1MC4wMCA1MC4wMCByZWN0CnQgcG9wCiBTcGFjZSAvU3BhY2UKCiAgQmFzZUZvbnRGYW1pbHkgKEhlbHZldGljYSkKICBDYWNoZUNvbXBsZXRlZCAodHJ1ZSkKICBEZWNvZGVGb3JtYXQgKHRydWUpCiAgRGlzcGxheSAoZmFsc2UpCiAgRW5jb2RpbmdTY2hlbWUgKEFkb2JlU3RhbmRhcmRFbmNvZGluZykKICBGb250RmlsbGluZ1ggMC4wMAogIEZvbnRNYXRyaXggWzEgMCAwIDEgMCAwIF0KICBGb250UmV2aXNpb24gMC4wMAogIEZvbnRTdGFja0hlaWdodCA1MC4wMAogIEZvbnRJZCAxCmVuZG9iagoNCjEgMCAwIDEgMCAwIGNtCmJ0CjIwIDM1IHRkCjAuMCAwLjAgMC4wIHJnCigtIDEtKSBUagplVAplbmRzdHJlYW0KZW5kb2JqCnhyZWYKMCA3CjAwMDAwMDAwMDAgNjU1MzUgZiAKMDAwMDAwMDAxNSAwMDAwMCBuIAowMDAwMDAwMTgzIDAwMDAwIG4gCjAwMDAwMDAyNjAgMDAwMDAgbiAKMDAwMDAwMDMyNSAwMDAwMCBuIAowMDAwMDAwNTEzIDAwMDAwIG4gCjAwMDAwMDA2MDYgMDAwMDAgbiAKdHJhaWxlcgo8PAovU2l6ZSA3Ci9Sb290IDIgMCBSCi9JbmZvIDEgMCBSCj4+CnN0YXJ0eHJlZgo5ODUKJSVFT0YK";
      const DEFAULT_DOC_NAME = "ContratoPadraoFontara.pdf";
      const DEFAULT_DOC_ID = "1";
      const DOCUSIGN_JS_IK = "f0197e49-8018-439d-88a4-996635a6044d"; 
      const DOCUSIGN_JS_ENVIRONMENT = "demo"; 
      const docusignUiHostOrigin = "https://apps-d.docusign.com"; 

      // Definindo as funções no escopo global ou de uma forma que loadPartials.js possa chamá-las
      // se a inicialização do header depender delas.
      // Para este script específico da página, elas podem ficar dentro do DOMContentLoaded.
      
      document.addEventListener('DOMContentLoaded', function() {
        // A lógica para atualizar o ano no footer será chamada por loadPartials.js se o footer for carregado dinamicamente.
        // Se o footer estiver estático nesta página, esta linha pode ficar:
        // const yearSpan = document.getElementById('current-year');
        // if (yearSpan) yearSpan.textContent = new Date().getFullYear();

        const envelopeForm = document.getElementById('envelopeForm');
        const useDefaultDocRadio = document.getElementById('useDefaultDoc');
        const useUploadedDocRadio = document.getElementById('useUploadedDoc');
        const fileUploadContainer = document.getElementById('fileUploadContainer');
        const uploadedDocInput = document.getElementById('uploadedDoc');
        const submitEnvelopeBtn = document.getElementById('submitEnvelopeBtn');
        
        const signingModalOverlay = document.getElementById('signingModalOverlay');
        const closeSigningModalBtn = document.getElementById('closeSigningModalBtn');
        const docusignViewContainer = document.getElementById('docusign-view-container');
        let mainHeader = null; // Será pego após o header ser carregado, se dinâmico
        let originalHeaderZIndex = ''; 
        
        function initializePageSpecificElements() {
            // Esta função pode ser chamada por loadPartials.js APÓS o header ser carregado,
            // ou pode ser simplificada se o header for estático nesta página.
            // Por enquanto, vamos assumir que mainHeader é pego aqui após DOMContentLoaded.
            mainHeader = document.getElementById('mainHeader');
        }
        initializePageSpecificElements(); // Chama para pegar o header se ele for estático

        function showFileUpload(show) { /* ... (como antes) ... */ }
        if(useDefaultDocRadio) useDefaultDocRadio.addEventListener('change', () => showFileUpload(false));
        if(useUploadedDocRadio) useUploadedDocRadio.addEventListener('change', () => showFileUpload(true));
        if(useDefaultDocRadio && useDefaultDocRadio.checked) showFileUpload(false);
        else if (useUploadedDocRadio && useUploadedDocRadio.checked) showFileUpload(true);

        function openSigningModal() {
            if (signingModalOverlay) {
                signingModalOverlay.style.display = 'flex';
                document.body.classList.add('modal-open');
                if (mainHeader) { // mainHeader pode ter sido pego após carregamento dinâmico
                    originalHeaderZIndex = mainHeader.style.zIndex; 
                    mainHeader.style.zIndex = '10'; 
                } else {
                    // Se o header for carregado dinamicamente e este script rodar antes,
                    // precisamos de uma forma de pegar o header após ele ser injetado.
                    // Para agora, vamos tentar pegar de novo.
                    const currentHeader = document.getElementById('mainHeader');
                    if (currentHeader) {
                        mainHeader = currentHeader;
                        originalHeaderZIndex = mainHeader.style.zIndex; 
                        mainHeader.style.zIndex = '10'; 
                    }
                }
            }
        }

        function closeSigningModal() {
            if (signingModalOverlay) {
                signingModalOverlay.style.display = 'none';
                document.body.classList.remove('modal-open');
                const currentHeader = document.getElementById('mainHeader'); // Pega o header novamente
                if (currentHeader) {
                    currentHeader.style.zIndex = originalHeaderZIndex || ''; 
                }
                if(docusignViewContainer) docusignViewContainer.innerHTML = ''; 
            }
        }
        
        if(closeSigningModalBtn) closeSigningModalBtn.addEventListener('click', closeSigningModal);
        if (signingModalOverlay) {
            signingModalOverlay.addEventListener('click', function(event) {
                if (event.target === signingModalOverlay) closeSigningModal();
            });
        }

        function handleDocusignEvent(docusignEventName, eventData, envelopeId, signerName) {
            console.log(`[Assinatura Embarcada] Evento Docusign: ${docusignEventName}`, eventData || '');
            const finalEnvelopeId = envelopeId || (eventData && eventData.data && eventData.data.envelopeId) || '';
            const returnUrlBase = `${window.location.origin}/agradecimento/obrigado.html?recipientName=${encodeURIComponent(signerName)}&envelopeId=${finalEnvelopeId}`;
            let eventParam = docusignEventName ? docusignEventName.toLowerCase().replace(/\s+/g, '_') : 'unknown';

            if (docusignEventName === 'SIGNING_COMPLETE' || docusignEventName === 'FINISH' || docusignEventName === 'DONE' || docusignEventName === 'signing_complete' ) {
                eventParam = 'signing_complete';
            } else if (['CLOSE_VIEW', 'CANCEL_SESSION', 'CANCEL', 'TAB_CLOSED', 'cancel', 'session_end_due_to_cancel'].includes(docusignEventName)) {
                eventParam = 'cancel';
            } else if (['DECLINE_SIGNING', 'DECLINE', 'decline'].includes(docusignEventName)) {
                eventParam = 'decline';
            } else if (['SESSION_END', 'TTL_EXPIRED', 'ERROR_OCCURRED', 'EXCEPTION', 'error', 'session_timeout', 'ttl_expired', 'exception'].includes(docusignEventName)) {
                 if (docusignEventName === 'ERROR_OCCURRED' || docusignEventName === 'EXCEPTION' || docusignEventName === 'error') {
                    eventParam = 'error';
                    console.error("Docusign.js: Erro na cerimônia.", eventData);
                    alert(`Ocorreu um erro na assinatura Docusign: ${eventData && eventData.data ? (eventData.data.message || eventData.data.error || 'Erro desconhecido') : 'Erro desconhecido'}`);
                 }
            } else {
                 console.warn("Evento Docusign não mapeado para redirecionamento:", docusignEventName);
                 return; 
            }

            closeSigningModal();
            if (eventParam !== 'error' || (eventData && eventData.data && eventData.data.isSigningCeremonyActive === false)) { 
                window.location.href = `${returnUrlBase}&event=${eventParam}`;
            } else if (eventParam === 'error') {
                console.error("Erro na cerimônia Docusign, modal fechado, sem redirecionamento.");
            }
        }
        
        window.addEventListener('message', (event) => {
            if (event.origin !== docusignUiHostOrigin && !docusignUiHostOrigin.includes(new URL(event.origin).host) ) {
                return;
            }
            if (typeof event.data === 'string' && event.data.includes('event=')) {
                const params = new URLSearchParams(event.data.startsWith('?') ? event.data.substring(1) : event.data);
                const docusignEvent = params.get('event');
                const envelopeIdFromEvent = params.get('envelopeId');
                const signerNameFromForm = document.getElementById('signerName') ? document.getElementById('signerName').value : 'Cliente';
                handleDocusignEvent(docusignEvent, null, envelopeIdFromEvent, signerNameFromForm);
            }
        }, false);

        if(envelopeForm) {
            envelopeForm.addEventListener('submit', async function(event) {
              event.preventDefault();
              const originalButtonInnerHTML = submitEnvelopeBtn.innerHTML;
              if(submitEnvelopeBtn) { /* ... (feedback no botão) ... */ }

              const signerName = document.getElementById('signerName').value;
              const signerEmail = document.getElementById('signerEmail').value;
              // ... (resto da coleta de dados como antes) ...
              const selectedExperience = document.querySelector('input[name="signingExperience"]:checked').value;
              
              let documentBase64 = '', documentName = '', clientUserId = '', envelopeId = '';

              try {
                if (useDefaultDocRadio.checked) { /* ... */ } else { /* ... */ }
                clientUserId = `fontara_${signerEmail.replace(/[^a-zA-Z0-9]/g, "")}_${Date.now()}`; 
                const envelopePayload = { /* ... (monta envelopePayload como antes) ... */ };
                if (selectedExperience === 'click_to_agree') { /* ... placeholder ... */ }

                let response = await fetch('/.netlify/functions/docusign-actions', { /* ... CREATE_DYNAMIC_EMBEDDED_ENVELOPE ... */ });
                if (!response.ok) { /* ... tratamento de erro ... */ }
                const envelopeResult = await response.json();
                envelopeId = envelopeResult.envelopeId;
                if (!envelopeId) throw new Error("ID do envelope não retornado.");
                
                const recipientViewPayload = { /* ... como antes ... */ };

                response = await fetch('/.netlify/functions/docusign-actions', { /* ... GET_EMBEDDED_SIGNING_URL ... */ });
                if (!response.ok) { /* ... tratamento de erro ... */ }
                const signingResult = await response.json();
                const signingUrl = signingResult.signingUrl;

                if (signingUrl) {
                  openSigningModal(); 
                  docusignViewContainer.innerHTML = ''; 

                  if (selectedExperience === 'classic') {
                    const iframe = document.createElement('iframe');
                    iframe.src = signingUrl; 
                    iframe.id = 'docusign-classic-iframe';
                    docusignViewContainer.appendChild(iframe);
                  } else { 
                    if (typeof window.DocuSign !== 'undefined' && typeof window.DocuSign.loadDocuSign === 'function') {
                        window.DocuSign.loadDocuSign(DOCUSIGN_JS_IK) 
                          .then((docusignSdk) => {
                            if (!docusignSdk || typeof docusignSdk.signing !== 'function') {
                                throw new Error("Falha na inicialização do Docusign.js SDK: docusignSdk.signing não é uma função.");
                            }
                            const sdkConfig = {
                                displayFormat: selectedExperience === 'focused' ? 'focused' : 'lucid',
                                DocusignPlatform: DOCUSIGN_JS_ENVIRONMENT, 
                                style: { branding: { primaryButton: { backgroundColor: '#007bff', color: '#ffffff' } } }
                            };
                            if (selectedExperience === 'click_to_agree') {
                                sdkConfig.termsOfService = [{
                                    type: "modal", 
                                    documentName: "Termos de Aceite Fontara", 
                                    text: "Ao prosseguir, você concorda com os Termos e Condições Adicionais da Fontara Financial.", 
                                    button: { text: "Eu Concordo", style: "primary" }
                                }];
                            }
                            
                            const signingInstance = docusignSdk.signing(sdkConfig);
                            
                            if (!signingInstance || typeof signingInstance.on !== 'function') {
                                throw new Error("Falha ao criar instância de assinatura do Docusign.js ou método '.on' ausente.");
                            }

                            // Nomes de evento corretos para Docusign.js v1.x (geralmente são strings simples)
                            // Consulte a documentação específica da versão carregada por bundle.js
                            // Os eventos mais comuns são 'ready', 'sessionEnd', 'error'.
                            // 'sessionEnd' pode ter sub-tipos em event.data.type
                            signingInstance.on('ready', (data) => console.log('Docusign.js SDK: Pronto', data));
                            signingInstance.on('sessionEnd', (sdkEventData) => handleDocusignEvent((sdkEventData.data && sdkEventData.data.type) || 'sessionEnd', sdkEventData.data, envelopeId, signerName));
                            signingInstance.on('error', (sdkEventData) => handleDocusignEvent('error', sdkEventData, envelopeId, signerName)); // eventData aqui é o erro em si
                            
                            signingInstance.mount(signingUrl, docusignViewContainer)
                              .catch(error => {
                                 console.error("Erro ao montar Docusign.js:", error);
                                 closeSigningModal();
                                 alert("Falha ao iniciar a experiência de assinatura Docusign (mount).");
                              });
                          })
                          .catch((ex) => {
                            console.error(`Erro ao carregar Docusign.js SDK (window.DocuSign.loadDocuSign): ${ex.message}`, ex);
                            closeSigningModal();
                            alert("Não foi possível carregar o componente de assinatura Docusign (SDK).");
                          });
                    } else {
                        console.error("Docusign.js SDK não está carregado.");
                        alert("Componente de assinatura Docusign não pôde ser carregado.");
                        closeSigningModal();
                    }
                  }
                } else { throw new Error("URL de assinatura não retornada."); }
              } catch (error) {
                console.error("Erro no processo Docusign:", error);
                alert(`Ocorreu um erro: ${error.message}`);
              } finally {
                if(submitEnvelopeBtn) { /* ... restaura botão ... */ }
              }
            });
        }
        // A função initializePageSpecificElements pode ser usada por loadPartials.js
        // Se esta página sempre tiver o header estático, ela pode ser chamada diretamente.
        // window.initializePageSpecificScripts = initializePageSpecificElements;
      });
    </script>
    <script src="./scripts/components.js"></script>
    <script src="./scripts/index.js"></script> 
  </body>
</html>
