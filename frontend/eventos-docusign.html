<script>
      document.addEventListener('DOMContentLoaded', function() {
        const yearSpan = document.getElementById('current-year');
        if (yearSpan) yearSpan.textContent = new Date().getFullYear();

        const eventListContainer = document.getElementById('eventListContainer');
        const loadingMessage = document.getElementById('loadingMessage'); // Certifique-se que este <p> existe dentro de eventListContainer
        const refreshDataBtn = document.getElementById('refreshDataBtn');

        function displayEvent(eventEntry) { // eventEntry é o objeto { id, receivedAt, eventType, relevantInfo }
          const card = document.createElement('div');
          card.className = 'event-card tw-bg-white dark:tw-bg-gray-700 tw-shadow-md tw-p-4 tw-rounded-lg tw-mb-4 tw-text-left';
          
          let content = `<p class="tw-text-xs tw-text-gray-500 dark:tw-text-gray-400"><strong>ID da Função:</strong> ${eventEntry.id || 'N/A'}</p>`;
          content += `<p><strong>Recebido pelo Portal em:</strong> ${eventEntry.receivedAt ? new Date(eventEntry.receivedAt).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'medium' }) : 'Data N/A'}</p>`;
          content += `<p><strong>Tipo de Evento Docusign:</strong> <span class="tw-font-semibold">${eventEntry.eventType || 'Desconhecido'}</span></p>`;
          
          content += '<hr class="tw-my-3 dark:tw-border-gray-600">';

          if (eventEntry.relevantInfo) {
            // Se há uma mensagem de erro/aviso em relevantInfo
            if (eventEntry.relevantInfo.message) {
              content += `<p class="tw-text-orange-600 dark:tw-text-orange-400"><strong>Status da Extração:</strong> ${eventEntry.relevantInfo.message}</p>`;
              if (eventEntry.relevantInfo.rawPreview) {
                content += `<p class="tw-mt-2"><strong>Preview do Payload Bruto (início):</strong></p><pre class="tw-text-xs">${eventEntry.relevantInfo.rawPreview.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre>`;
              }
            } else { // Se relevantInfo tem dados extraídos do envelope
              content += `<p><strong>ID do Envelope:</strong> ${eventEntry.relevantInfo.envelopeId || 'N/A'}</p>`;
              content += `<p><strong>Status do Envelope:</strong> <span class="tw-font-semibold">${eventEntry.relevantInfo.status || 'N/A'}</span></p>`;
              content += `<p><strong>Assunto:</strong> ${eventEntry.relevantInfo.subject || 'N/A'}</p>`;
              if (eventEntry.relevantInfo.timeGenerated) {
                content += `<p><strong>Evento Gerado em (Docusign):</strong> ${new Date(eventEntry.relevantInfo.timeGenerated).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'medium' })}</p>`;
              }
              if (eventEntry.relevantInfo.statusChangedDateTime && eventEntry.relevantInfo.statusChangedDateTime !== 'N/A') {
                content += `<p><strong>Status Alterado em (Docusign):</strong> ${new Date(eventEntry.relevantInfo.statusChangedDateTime).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'medium' })}</p>`;
              }
              if(eventEntry.relevantInfo.recipientsPreview && eventEntry.relevantInfo.recipientsPreview.length > 0){
                content += `<div class="tw-mt-2"><p><strong>Destinatários (Preview):</strong></p><ul class="tw-list-disc tw-list-inside tw-ml-4">`;
                eventEntry.relevantInfo.recipientsPreview.forEach(recip => {
                    content += `<li>${recip}</li>`;
                });
                content += `</ul></div>`;
              }
            }
          } else {
            content += `<p class="tw-text-red-500">Objeto 'relevantInfo' ausente no evento.</p>`
          }

          card.innerHTML = content;
          return card;
        }

        async function fetchDocusignEvents() {
          if (loadingMessage) loadingMessage.textContent = 'Carregando eventos...';
          // Limpa apenas os cards de eventos, não a mensagem de loading se ela estiver fora de um card
          const existingCards = eventListContainer.querySelectorAll('.event-card');
          existingCards.forEach(card => card.remove());
          
          if (!eventListContainer.contains(loadingMessage) && loadingMessage) { // Garante que a mensagem de loading esteja lá
            eventListContainer.insertBefore(loadingMessage, eventListContainer.firstChild);
          }


          try {
            const response = await fetch('/.netlify/functions/get-docusign-events');
            if (!response.ok) {
              const errorData = await response.json().catch(() => ({ message: `Erro HTTP: ${response.status}` }));
              throw new Error(errorData.message || `Erro HTTP: ${response.status}`);
            }
            const events = await response.json();

            if (loadingMessage) loadingMessage.remove();

            if (events && Array.isArray(events) && events.length > 0) {
              events.forEach(eventFullData => { 
                const eventCard = displayEvent(eventFullData); 
                eventListContainer.appendChild(eventCard);
              });
            } else {
              eventListContainer.innerHTML = '<p class="tw-text-center tw-py-10">Nenhum evento recente do Docusign encontrado.</p>';
            }
          } catch (error) {
            console.error('Erro ao buscar eventos Docusign:', error);
            if (loadingMessage) loadingMessage.remove();
            eventListContainer.innerHTML = `<p class="tw-text-center tw-text-red-500 tw-py-10">Falha ao carregar eventos: ${error.message}</p>`;
          }
        }

        if (refreshDataBtn) {
            refreshDataBtn.addEventListener('click', fetchDocusignEvents);
        }
        
        fetchDocusignEvents();
      });
    </script>
    <script src="./scripts/components.js"></script>
    <script src="./scripts/index.js"></script>
  </body>
</html>