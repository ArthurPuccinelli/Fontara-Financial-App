<!DOCTYPE html>
<html lang="pt-BR"> <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assinatura Embarcada - Fontara Financial</title>
    <meta
      name="description"
      content="Forneça os dados para assinatura digital do seu documento."
    />
    <link rel="shortcut icon" href="/assets/logo/logo.png" type="image/x-icon" />
    <link rel="stylesheet" href="/css/tailwind-build.css" />
    <link rel="stylesheet" href="/css/index.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css"
    />
    <style>
      body { 
        display: flex; 
        flex-direction: column; 
        min-height: 100vh; 
        background-color: #f9fafb; /* Cor de fundo light padrão (Tailwind gray-50) */
      }
      html.tw-dark body { 
        background-color: #1f2937; /* Cor de fundo dark padrão (Tailwind gray-800) */
      }
      main { 
        flex-grow: 1; /* Faz o main ocupar o espaço restante */
        /* padding-top será ajustado pelo script abaixo para acomodar o header fixo */
        display: flex; /* Habilita flexbox para centralização */
        flex-direction: column; /* Empilha os filhos do main verticalmente */
        align-items: center; /* Centraliza os filhos horizontalmente */
        justify-content: center; /* Centraliza os filhos verticalmente */
      }
      .form-input-custom {
        @apply tw-block tw-w-full tw-px-4 tw-py-3 tw-border tw-border-black dark:tw-border-gray-500 tw-bg-gray-100 dark:tw-bg-gray-700 tw-rounded-md tw-shadow-sm focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-indigo-500 focus:tw-border-indigo-500 dark:tw-text-white tw-text-base;
        min-height: 50px; 
      }
      .form-label {
        @apply tw-block tw-mb-2 tw-text-sm tw-font-medium tw-text-gray-900 dark:tw-text-gray-300;
      }
    </style>
  </head>
  <body>
    <div id="header-placeholder"></div>

    <script>
      function adjustMainPadding() {
        const header = document.getElementById('mainHeader'); // ID do elemento <header> em _header.html
        const mainContent = document.querySelector('main');
        if (header && mainContent) {
          const headerHeight = header.offsetHeight;
          mainContent.style.paddingTop = headerHeight + 'px';
          // Adiciona um padding-bottom para não colar no footer, se o footer for de altura variável
          // ou se o conteúdo do main for muito pequeno.
          // mainContent.style.paddingBottom = '50px'; // Exemplo
        } else if (mainContent) {
          mainContent.style.paddingTop = '76px'; // Fallback: 60px header + 16px (p-4)
        }
      }
      // Chama no DOMContentLoaded se o header for estático,
      // mas como o header é dinâmico, chamaremos isso em initializePageSpecificScripts
      // ou após a execução de initializePagePartials.
      // Para simplificar, vamos chamar após o loadPartials garantir que o header existe.
    </script>

    <main class="tw-container tw-mx-auto tw-p-4"> <div class="tw-w-full"> 
        <h1 class="tw-text-3xl tw-font-bold tw-mb-6 tw-text-center dark:tw-text-white">
            Assinatura de Documentos
        </h1>
        <div class="tw-max-w-xl tw-mx-auto tw-bg-white dark:tw-bg-gray-900 tw-p-8 tw-rounded-lg tw-shadow-md">
            <form id="envelopeForm" class="tw-space-y-6">
                <div>
                    <label for="signerEmail" class="form-label">Email do Signatário:</label>
                    <input type="email" id="signerEmail" name="signerEmail" class="form-input-custom" required value="teste@gmail.com">
                </div>
                <div>
                    <label for="signerName" class="form-label">Nome do Signatário:</label>
                    <input type="text" id="signerName" name="signerName" class="form-input-custom" required value="Nome Teste Assinatura">
                </div>
                <button type="submit" id="submitEnvelopeBtn" class="btn tw-w-full">
                    Enviar para Assinatura
                </button>
            </form>
        </div>
      </div>

      <div id="docusignSigningModal" class="tw-fixed tw-inset-0 tw-bg-gray-600 tw-bg-opacity-50 tw-hidden tw-items-center tw-justify-center tw-z-50">
          <div class="tw-bg-white dark:tw-bg-gray-800 tw-p-2 tw-rounded-lg tw-shadow-xl tw-w-11/12 md:tw-w-3/4 lg:tw-w-2/3 tw-h-[90vh] tw-flex tw-flex-col">
              <div class="tw-flex tw-justify-between tw-items-center tw-p-2 tw-border-b dark:tw-border-gray-700">
                  <h3 class="tw-text-lg tw-font-semibold dark:tw-text-white">Assinatura do Documento</h3>
                  <button id="closeDocusignModalBtn" type="button" class="tw-text-gray-400 hover:tw-text-gray-600 dark:hover:tw-text-white">
                      <i class="bi bi-x-lg tw-text-xl"></i>
                  </button>
              </div>
              <div id="docusign-recipient-view" class="tw-flex-grow tw-p-1 tw-overflow-auto">
                  </div>
          </div>
      </div>
    </main>

    <div id="footer-placeholder"></div>

    <script src="/scripts/index.js"></script>
    <script src="/scripts/loadPartials.js" defer></script>

    <script>
      function initializeAssinaturaPageScripts() {
        console.log("assinatura-embarcada.html: Scripts específicos da página inicializados.");
        
        // Chama o ajuste de padding após os parciais (e o header) terem sido carregados
        if (typeof adjustMainPadding === 'function') {
            adjustMainPadding();
            // Se o header tiver altura variável devido ao conteúdo ou responsividade,
            // pode ser necessário re-chamar adjustMainPadding em 'resize'
            window.addEventListener('resize', adjustMainPadding);
        }

        const form = document.getElementById('envelopeForm');
        const submitEnvelopeBtn = document.getElementById('submitEnvelopeBtn');
        const docusignModal = document.getElementById('docusignSigningModal');
        const closeModalBtn = document.getElementById('closeDocusignModalBtn');
        const docusignRecipientView = document.getElementById('docusign-recipient-view');

        function openDocusignSigningModal(url) {
            if (!docusignRecipientView || !docusignModal) return;
            docusignRecipientView.innerHTML = ''; 
            const iframe = document.createElement('iframe');
            iframe.src = url;
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            docusignRecipientView.appendChild(iframe);
            docusignModal.classList.remove('tw-hidden');
            docusignModal.classList.add('tw-flex');
        }

        function closeDocusignSigningModal() {
            if (!docusignRecipientView || !docusignModal) return;
            docusignModal.classList.add('tw-hidden');
            docusignModal.classList.remove('tw-flex');
            docusignRecipientView.innerHTML = '';
        }

        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', closeDocusignSigningModal);
        }

        if (form) {
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                const originalButtonInnerHTML = submitEnvelopeBtn.innerHTML;
                submitEnvelopeBtn.disabled = true;
                submitEnvelopeBtn.innerHTML = '<span class="tw-animate-pulse">Processando...</span>';

                const formData = new FormData(form);
                const payload = {
                    signerEmail: formData.get('signerEmail'),
                    signerName: formData.get('signerName'),
                };

                try {
                    // Ação para criar envelope (ajuste conforme sua Netlify Function)
                    let response = await fetch('/.netlify/functions/docusign-actions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            action: "CREATE_ENVELOPE_FOR_SIGNING", 
                            payload: payload 
                        })
                    });
                    if (!response.ok) throw await response.json().catch(() => new Error(`Erro HTTP ${response.status}`));
                    const envelopeResult = await response.json();
                    if (!envelopeResult.envelopeId) throw new Error("ID do Envelope não retornado.");

                    // Ação para obter URL de assinatura
                    const recipientViewPayload = {
                        envelopeId: envelopeResult.envelopeId,
                        recipientEmail: payload.signerEmail,
                        recipientName: payload.signerName,
                        returnUrl: window.location.href + '?event=signing_complete', 
                        authenticationMethod: 'None' 
                    };
                    response = await fetch('/.netlify/functions/docusign-actions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: "GET_EMBEDDED_SIGNING_URL", payload: recipientViewPayload })
                    });
                    if (!response.ok) throw await response.json().catch(() => new Error(`Erro HTTP ${response.status}`));
                    const signingResult = await response.json();
                    if (!signingResult.signingUrl) throw new Error("URL de assinatura não retornada.");
                    
                    openDocusignSigningModal(signingResult.signingUrl);

                } catch (error) {
                    console.error("Erro no processo Docusign:", error);
                    alert(`Ocorreu um erro: ${error.error || error.message}`);
                } finally {
                    if(submitEnvelopeBtn) {
                        submitEnvelopeBtn.disabled = false;
                        submitEnvelopeBtn.innerHTML = originalButtonInnerHTML; 
                    }
                }
            });
        }
      }
      window.initializePageSpecificScripts = initializeAssinaturaPageScripts;
    </script>
  </body>
</html>
