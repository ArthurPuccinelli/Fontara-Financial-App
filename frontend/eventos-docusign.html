<!DOCTYPE html>
<html lang="pt-BR" class="tw-dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Eventos dos Envelopes - Fontara Financial</title>
    <meta
      name="description"
      content="Visualização e filtragem dos últimos 100 eventos de envelopes Docusign."
    />
    <link rel="shortcut icon" href="./assets/logo/logo.png" type="image/x-icon" />
    <link rel="stylesheet" href="./css/tailwind-build.css" />
    <link rel="stylesheet" href="./css/index.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css"
      integrity="sha512-dPXYcDub/aeb08c63jRq/k6GaKccl256JQy/AnOq7CAnEZ9FzSL9wSbcZkMp4R26vBsMLFYH4kQ67/bbV8XaCQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      .content-wrapper { min-height: 70vh; }
      .event-card {
        border: 1px solid #e2e8f0; /* coolGray-200 */
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 0.5rem; /* rounded-lg */
        transition: box-shadow 0.2s ease-in-out;
      }
      .dark .event-card {
        border-color: #4a5568; /* coolGray-700 */
        background-color: #2d3748; /* coolGray-800 */
      }
      .event-card:hover {
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      }
      .dark .event-card:hover {
         box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3), 0 2px 4px -1px rgba(0,0,0,0.2);
      }
      .event-card strong { color: #2b6cb0; /* blue-600 */ }
      .dark .event-card strong { color: #63b3ed; /* blue-300 */ }
      pre {
        background-color: #f7fafc; /* coolGray-100 */
        padding: 0.75em 1em;
        border-radius: 0.375rem; /* rounded-md */
        overflow-x: auto;
        font-size: 0.8em;
        margin-top: 0.5rem;
        border: 1px solid #e2e8f0; /* coolGray-200 */
        max-height: 200px; 
      }
      .dark pre {
        background-color: #1a202c; /* coolGray-900 */
        color: #cbd5e0; /* coolGray-300 */
        border-color: #2d3748; /* coolGray-700 */
      }
      .filter-input {
        @apply tw-block tw-w-full tw-px-3 tw-py-2 tw-border tw-border-gray-300 dark:tw-border-gray-600 tw-rounded-md tw-shadow-sm focus:tw-outline-none focus:tw-ring-indigo-500 focus:tw-border-indigo-500 sm:tw-text-sm dark:tw-bg-gray-700 dark:tw-text-white;
      }
      .delete-btn {
        @apply tw-ml-auto tw-px-3 tw-py-1 tw-bg-red-500 hover:tw-bg-red-600 tw-text-white tw-text-xs tw-font-semibold tw-rounded tw-shadow focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-red-500 focus:tw-ring-opacity-50 tw-transition-colors;
      }
      .form-checkbox { 
        @apply tw-h-4 tw-w-4 tw-text-indigo-600 tw-border-gray-300 dark:tw-border-gray-600 tw-rounded focus:tw-ring-indigo-500 dark:tw-bg-gray-700 dark:focus:tw-ring-offset-gray-800;
      }
      .form-checkbox-label { 
        @apply tw-ml-2 tw-block tw-text-sm tw-font-normal tw-text-gray-700 dark:tw-text-gray-300 tw-cursor-pointer;
      }
      .filter-group-title { /* Para "Filtrar por Texto", "Campos a Exibir", "Eventos do Envelope", "Eventos de Destinatário" */
        @apply tw-block tw-text-lg tw-font-semibold tw-text-gray-800 dark:tw-text-gray-100 tw-mb-1;
      }
      .filter-group-subtitle { /* Descrição abaixo do título do grupo de filtro de texto */
         @apply tw-text-xs tw-text-gray-600 dark:tw-text-gray-400 tw-mb-2;
      }
      .checkbox-grid { /* Grade para os checkboxes dentro de cada grupo de filtro */
        @apply tw-grid tw-grid-cols-1 sm:tw-grid-cols-2 tw-gap-x-4 tw-gap-y-1 tw-mt-2;
      }

      /* Estilos para a área de filtros e colunas */
      .filters-area {
        background-color: #f9fafb; /* Cor de fundo similar a tw-gray-50 */
        padding: 1.5rem; /* Corresponde a tw-p-6 */
        border-radius: 0.5rem; /* Corresponde a tw-rounded-lg */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); /* Sombra similar a tw-shadow-lg ou md */
        margin-bottom: 2rem; /* tw-mb-8 */
      }
      .dark .filters-area {
        background-color: #1f2937; /* Cor de fundo similar a tw-gray-800 */
      }
      .filters-area-title {
        font-size: 1.25rem; /* tw-text-xl */
        font-weight: 700; /* tw-font-bold */
        margin-bottom: 1.5rem; /* tw-mb-6 */
        padding-bottom: 0.75rem; /* tw-pb-3 */
        border-bottom: 1px solid #e5e7eb; /* tw-border-gray-200 */
        color: #111827; /* tw-text-gray-900 */
      }
      .dark .filters-area-title {
        border-color: #374151; /* tw-border-gray-700 */
        color: #f3f4f6; /* tw-text-gray-100 */
      }
      .filter-columns-container {
        display: flex;
        flex-direction: column; /* Empilhado por padrão (mobile) */
        gap: 1.5rem; 
      }
      @media (min-width: 1024px) { /* Breakpoint lg (1024px) para 3 colunas */
        .filter-columns-container {
          flex-direction: row;
          justify-content: space-between;
        }
        .filter-column {
          flex: 1 1 0; /* Permite que as colunas cresçam e encolham igualmente */
          min-width: 200px; /* Largura mínima para cada coluna */
          /* Adicione um max-width se quiser limitar o quão largas elas podem ficar: */
          /* max-width: calc(33.333% - 1rem);  1.5rem gap / 2 = 0.75rem. 1.5rem * 2 = 3rem total gap. (100% - 3rem)/3 */
        }
      }
      .filter-group-heading {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem; 
      }
    </style>
  </head>
  <body class="tw-flex tw-min-h-[100vh] tw-flex-col tw-bg-[#fcfcfc] tw-text-black dark:tw-bg-black dark:tw-text-white">
    <header
      id="mainHeader" class="lg:tw-px-4 tw-max-w-[100vw] tw-max-w-lg:tw-mr-auto max-lg:tw-top-0 tw-fixed tw-top-4 lg:tw-left-1/2 lg:tw--translate-x-1/2 tw-z-20 tw-flex tw-h-[60px] tw-w-full tw-text-gray-700 tw-bg-white dark:tw-text-gray-200 dark:tw-bg-[#17181b] tw-px-[3%] tw-rounded-md lg:tw-max-w-5xl tw-shadow-md dark:tw-shadow-gray-700 lg:tw-justify-around lg:!tw-backdrop-blur-lg lg:tw-opacity-[0.99]">
      <a class="tw-flex tw-p-[4px] tw-gap-2 tw-place-items-center" href="index.html"><div class="tw-h-[30px] tw-max-w-[100px]"><img src="./assets/logo/logo.png" alt="Fontara Financial Logo" class="tw-object-contain tw-h-full tw-w-full dark:tw-invert"/></div></a>
      <div class="collapsible-header animated-collapse max-lg:tw-shadow-md" id="collapsed-header-items"><nav class="tw-relative tw-flex tw-h-full max-lg:tw-h-max tw-w-max tw-gap-5 tw-text-base max-lg:tw-mt-[30px] max-lg:tw-flex-col max-lg:tw-gap-5 lg:tw-mx-auto tw-place-items-center"><a class="header-links" href="index.html#hero-section"> Início </a><a class="header-links" href="index.html#casos-de-sucesso"> Sucesso </a><a class="header-links" href="index.html#nossos-servicos"> Serviços </a><div class="tw-relative tw-flex tw-flex-col tw-place-items-center"><div id="nav-dropdown-toggle-0" class="max-lg:tw-max-w-fit tw-flex header-links tw-gap-1 tw-place-items-center"><span class=""> Soluções </span> <i class="tw-text-sm bi bi-chevron-down"></i></div><nav id="nav-dropdown-list-0" data-open="false" class="tw-scale-0 tw-opacity-0 lg:tw-fixed tw-flex lg:tw-top-[80px] lg:tw-left-1/2 lg:tw--translate-x-1/2 tw-w-[90%] tw-rounded-lg max-lg:tw-h-0 max-lg:tw-w-0 lg:tw-h-auto tw-overflow-hidden tw-bg-white dark:tw-bg-[#17181B] tw-duration-300 tw-transition-opacity tw-shadow-lg tw-p-4"><div class="tw-grid max-xl:tw-flex max-xl:tw-flex-col tw-justify-around tw-grid-cols-2 tw-w-full"><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="credito-imobiliario.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-house-door"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Crédito Imobiliário</div><p>Simulação e aprovação rápida de crédito</p></div></a><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="previdencia-privada.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-shield-shaded"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Previdência Privada</div><p>Garanta tranquilidade para o seu futuro.</p></div></a><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="seguros.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-umbrella"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Seguros</div><p>Proteja seu patrimônio e sua família</p></div></a><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="emprestimo-pessoal.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-cash-coin"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Empréstimo Pessoal</div><p>Crédito para você nos momentos mais difíceis.</p></div></a><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="financiamento.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-receipt-cutoff"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Financiamento</div><p>Conquiste seus sonhos</p></div></a><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="investimentos.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-graph-up-arrow"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Investimentos</div><p>Renda fixa, renda variável e tesouro direto.</p></div></a><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="assinatura-embarcada.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-vector-pen"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Assinatura Embarcada</div><p>Assine seus documentos de forma digital e integrada.</p></div></a><a class="header-links tw-flex tw-text-left tw-gap-4 !tw-p-4" href="atualizacao-perfil-investidor.html"><div class="tw-font-semibold tw-text-3xl"><i class="bi bi-person-lines-fill"></i></div><div class="tw-flex tw-flex-col tw-gap-2"><div class="tw-text-lg tw-text-black dark:tw-text-white tw-font-medium">Atualização do Perfil de Investidor</div><p>Mantenha seu perfil atualizado.</p></div></a></div></nav></div><a class="header-links" href="index.html#faq"> FAQ </a></nav><div class="lg:tw-mx-4 tw-flex tw-place-items-center tw-gap-[20px] tw-text-base max-md:tw-w-full max-md:tw-flex-col max-md:tw-place-content-center"><button type="button" onclick="toggleMode()" class="header-links tw-text-gray-600 dark:tw-text-gray-300" title="Alternar tema" id="theme-toggle"><i class="bi bi-sun" id="toggle-mode-icon"></i></button><a href="#" aria-label="Acessar sua conta" class="btn tw-flex tw-gap-3 tw-px-3 tw-py-2 tw-transition-transform tw-duration-[0.3s] hover:tw-translate-x-2"><span>Área do Cliente</span><i class="bi bi-arrow-right"></i></a></div></div><button class="bi bi-list tw-absolute tw-right-3 tw-top-3 tw-z-50 tw-text-3xl tw-text-gray-500 lg:tw-hidden" onclick="toggleHeader()" aria-label="menu" id="collapse-btn"></button>
    </header>

    <main class="tw-mt-20 tw-pt-10 tw-pb-10 tw-px-4 md:tw-px-[5%] lg:tw-px-[10%] content-wrapper">
      <div class="page-container">
        <div class="tw-flex tw-flex-col sm:tw-flex-row sm:tw-justify-between sm:tw-items-center tw-mb-8">
            <h1 class="tw-text-3xl md:tw-text-4xl tw-font-semibold tw-text-gray-900 dark:tw-text-gray-100 tw-mb-4 sm:tw-mb-0">
                Últimos Eventos dos Envelopes
            </h1>
            <button id="refreshDataBtn" class="btn tw-self-start sm:tw-self-auto">
                <i class="bi bi-arrow-clockwise tw-mr-2"></i>Atualizar Dados
            </button>
        </div>

        <div id="filtersArea-new" class="filters-area">
            <h2 class="filters-area-title">
                <i class="bi bi-funnel-fill tw-mr-2"></i>Opções de Filtro e Visualização
            </h2>
            
            <div class="filter-text-input-container">
                <label for="filterInput" class="filter-group-title">Filtrar por Texto:</label>
                <p class="form-label-sm">Busque em qualquer informação do evento.</p>
                <input type="text" id="filterInput" class="filter-input md:tw-max-w-xl" placeholder="Digite para filtrar...">
            </div>

            <div class="filter-columns-container-flex">
                <div class="filter-column">
                    <div class="filter-group-heading">
                        <h3 class="filter-group-title">Campos a Exibir:</h3>
                        <div class="select-all-container">
                            <input type="checkbox" id="selectAllVisibleFields" class="form-checkbox select-all-checkbox" data-group="fieldVisibility">
                            <label for="selectAllVisibleFields" class="form-checkbox-label tw-text-xs">Todos</label>
                        </div>
                    </div>
                    <div id="fieldVisibilityFiltersContainer" class="checkbox-grid">
                        {/* JS populates this */}
                    </div>
                </div>

                <div class="filter-column">
                    <div class="filter-group-heading">
                        <h3 class="filter-group-title">Eventos do Envelope:</h3>
                        <div class="select-all-container">
                            <input type="checkbox" id="selectAllEnvelopeEvents" class="form-checkbox select-all-checkbox" data-group="envelopeEvents">
                            <label for="selectAllEnvelopeEvents" class="form-checkbox-label tw-text-xs">Todos</label>
                        </div>
                    </div>
                    <div id="envelopeEventTypeFiltersContainer" class="checkbox-grid">
                        {/* JS populates this */}
                    </div>
                </div>
                
                <div class="filter-column">
                    <div class="filter-group-heading">
                        <h3 class="filter-group-title">Eventos de Destinatário:</h3>
                        <div class="select-all-container">
                            <input type="checkbox" id="selectAllRecipientEvents" class="form-checkbox select-all-checkbox" data-group="recipientEvents">
                            <label for="selectAllRecipientEvents" class="form-checkbox-label tw-text-xs">Todos</label>
                        </div>
                    </div>
                    <div id="recipientEventTypeFiltersContainer" class="checkbox-grid">
                        {/* JS populates this */}
                    </div>
                </div>
            </div>
        </div>

        <div id="eventListContainer" class="tw-mt-8">
          <p id="loadingMessage" class="tw-text-center tw-py-4">Carregando eventos...</p>
        </div>
      </div>
    </main>

    <footer class="tw-mt-auto tw-flex tw-flex-col tw-w-full tw-gap-4 tw-text-sm tw-pt-[5%] tw-pb-10 tw-px-[5%] md:tw-px-[10%] tw-text-black dark:tw-text-white max-md:tw-flex-col">
      <div class="tw-flex max-md:tw-flex-col max-md:tw-gap-6 tw-gap-3 tw-w-full tw-place-content-around"><div class="tw-flex tw-h-full tw-w-[250px] tw-flex-col tw-place-items-center tw-gap-6 max-md:tw-w-full"><a href="index.html" class="tw-w-full tw-place-items-center tw-flex tw-flex-col tw-gap-6"><img src="./assets/logo/logo.png" alt="Fontara Financial Logo" class="tw-max-w-[120px] dark:tw-invert"/></a><div class="tw-flex tw-gap-4 tw-text-lg"><a href="https://github.com/PaulleDemon/" aria-label="Github" target="_blank" rel="noopener"><i class="bi bi-github"></i></a><a href="https://twitter.com/pauls_freeman" aria-label="Twitter" target="_blank" rel="noopener"><i class="bi bi-twitter"></i></a><a href="https://www.linkedin.com/" aria-label="Linkedin" target="_blank" rel="noopener"><i class="bi bi-linkedin"></i></a></div></div><div class="tw-flex max-md:tw-flex-col tw-flex-wrap tw-gap-6 tw-h-full tw-w-full tw-justify-around"><div class="tw-flex tw-h-full tw-w-[200px] tw-flex-col tw-gap-4"><h2 class="tw-text-xl">Recursos</h2><div class="tw-flex tw-flex-col tw-gap-3"><a href="#" class="footer-link">Blog Financeiro</a><a href="#" class="footer-link">Simuladores</a><a href="#" class="footer-link">Glossário Financeiro</a><a href="#" class="footer-link">Status dos Serviços</a><a href="#" class="footer-link">Taxas e Tarifas</a></div></div><div class="tw-flex tw-h-full tw-w-[200px] tw-flex-col tw-gap-4"><h2 class="tw-text-xl">Fontara</h2><div class="tw-flex tw-flex-col tw-gap-3"><a href="#" class="footer-link">Sobre Nós</a><a href="#" class="footer-link">Carreiras</a><a href="#" class="footer-link">Imprensa</a><a href="#" class="footer-link">Fale Conosco</a><a href="#" class="footer-link">Compliance</a></div></div><div class="tw-flex tw-h-full tw-w-[200px] tw-flex-col tw-gap-4"><h2 class="tw-text-xl">Legal</h2><div class="tw-flex tw-flex-col tw-gap-3"><a href="#" class="footer-link">Termos de Uso</a><a href="#" class="footer-link">Política de Privacidade</a><a href="#" class="footer-link">Ouvidoria</a></div></div></div></div><hr class="tw-mt-8" /><div class="tw-mt-2 tw-flex tw-gap-2 tw-flex-col tw-text-gray-700 dark:tw-text-gray-300 tw-place-items-center tw-text-[12px] tw-w-full tw-text-center tw-place-content-around"><span>Copyright &#169; 2023-<span id="current-year"></span> Fontara Financial. Todos os direitos reservados.</span><span>Todas as marcas registradas e direitos autorais pertencem aos seus respectivos proprietários.</span></div>
    </footer>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const yearSpan = document.getElementById('current-year');
        if (yearSpan) yearSpan.textContent = new Date().getFullYear();

        const eventListContainer = document.getElementById('eventListContainer');
        const loadingMessage = document.getElementById('loadingMessage');
        const refreshDataBtn = document.getElementById('refreshDataBtn');
        const filterInput = document.getElementById('filterInput');
        
        const fieldVisibilityFiltersContainer = document.getElementById('fieldVisibilityFiltersContainer');
        const envelopeEventTypeFiltersContainer = document.getElementById('envelopeEventTypeFiltersContainer');
        const recipientEventTypeFiltersContainer = document.getElementById('recipientEventTypeFiltersContainer');

        let allFetchedEvents = []; 
        
        const eventFilterConfig = {
            groups: [
                {
                    name: "Eventos do Envelope", 
                    containerId: 'envelopeEventTypeFiltersContainer',
                    selectAllId: 'selectAllEnvelopeEvents',
                    events: [
                        { label: "Enviado", value: "envelope-sent" }, { label: "Entregue", value: "envelope-delivered" },
                        { label: "Concluído", value: "envelope-completed" }, { label: "Recusado", value: "envelope-declined" },
                        { label: "Anulado", value: "envelope-voided" }, { label: "Reenviado", value: "envelope-resent" },
                        { label: "Corrigido", value: "envelope-corrected" }, { label: "Criado", value: "envelope-created" },
                        { label: "Excluído", value: "envelope-deleted" }, { label: "Descartado", value: "envelope-discard" }
                    ]
                },
                {
                    name: "Eventos de Destinatários",
                    containerId: 'recipientEventTypeFiltersContainer',
                    selectAllId: 'selectAllRecipientEvents',
                    events: [
                        { label: "Enviado (Dest.)", value: "recipient-sent" }, { label: "Entregue (Dest.)", value: "recipient-delivered" },
                        { label: "Concluído (Dest.)", value: "recipient-completed" }, { label: "Recusado (Dest.)", value: "recipient-declined" },
                        { label: "Falha Autenticação", value: "recipient-authenticationfailed" },
                        { label: "Reatribuído", value: "recipient-reassign"}, { label: "Concluir Depois", value: "recipient-finish-later"},
                        { label: "Resp. Automática", value: "recipient-autoresponded" }, { label: "Reenviado (Dest.)", value: "recipient-resent"}
                    ]
                }
            ],
            displayableFields: [
                { keyForId: "id", label: "ID Função", defaultChecked: false, path: 'id' },
                { keyForId: "receivedAt", label: "Recebido em", defaultChecked: true, path: 'receivedAt', type: 'datetime' },
                { keyForId: "eventType", label: "Tipo Evento", defaultChecked: true, path: 'eventType', isEventType: true },
                // Ajuste os paths para apontar para eventEntry.docusignPayload, que agora contém o objeto 'data' do Docusign
                { keyForId: "envelopeId", label: "ID Envelope", defaultChecked: true, path: 'docusignPayload.envelopeId' },
                { keyForId: "status", label: "Status Envelope", defaultChecked: true, path: 'docusignPayload.envelopeSummary.status' },
                { keyForId: "subject", label: "Assunto", defaultChecked: true, path: 'docusignPayload.envelopeSummary.emailSubject' },
                { keyForId: "timeGeneratedEvent", label: "Gerado (Evento Docusign)", defaultChecked: false, path: 'docusignPayload.generatedDateTime', type: 'datetime' }, // Path corrigido, é do evento geral
                { keyForId: "statusChangedDateTime", label: "Status Alterado", defaultChecked: false, path: 'docusignPayload.envelopeSummary.statusChangedDateTime', type: 'datetime' },
                { keyForId: "senderName", label: "Remetente", defaultChecked: false, path: 'docusignPayload.envelopeSummary.sender.userName' },
                // Para 'recipients' e 'documentNames', precisaremos de uma formatação especial em renderEvents
                { keyForId: "recipients", label: "Destinatários", defaultChecked: false, path: 'docusignPayload.envelopeSummary.recipients', isComplexObject: true }, 
                { keyForId: "documentNames", label: "Documentos", defaultChecked: false, path: 'docusignPayload.envelopeSummary.envelopeDocuments', isDocArray: true },
                { keyForId: "processingError", label: "Erro Processamento (Listener)", defaultChecked: true, path: 'processingError' },
                { keyForId: "rawPayloadPreview", label: "Preview Payload Bruto (Listener)", defaultChecked: false, path: 'relevantInfo.rawPreview', isPre: true } // relevantInfo não existe mais nesse nível
            ]
        };

        function getNestedValue(obj, path) {
            if (!path || !obj) return undefined;
            // Lida com o caso de 'docusignPayload' poder ser null (se o parse inicial falhou)
            if (path.startsWith('docusignPayload.') && obj.docusignPayload === null) return undefined;
            return path.split('.').reduce((acc, part) => acc && typeof acc === 'object' && acc[part] !== undefined && acc[part] !== null ? acc[part] : undefined, obj);
        }
        
        function populateCheckboxes(targetContainer, items, groupNameAttributeForCheckboxName, isVisibilityFilter, selectAllCheckboxId) {
            if (!targetContainer) return;
            targetContainer.innerHTML = ''; 

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'tw-flex tw-items-center';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                const valueForCheckbox = isVisibilityFilter ? item.path : item.value; // Usa item.path para visibilidade
                const idSuffix = valueForCheckbox.replace(/[\s.\-]/g, '');
                checkbox.id = `filter-${groupNameAttributeForCheckboxName}-${idSuffix}`;
                checkbox.name = groupNameAttributeForCheckboxName;
                checkbox.value = valueForCheckbox;
                checkbox.className = isVisibilityFilter ? 'form-checkbox field-visibility-filter' : 'form-checkbox event-type-filter';
                if (isVisibilityFilter) checkbox.checked = item.defaultChecked;
                
                checkbox.addEventListener('change', function() {
                    applyFilters();
                    updateSelectAllCheckboxState(selectAllCheckboxId);
                });

                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.className = 'form-checkbox-label';
                label.textContent = item.label;
                div.appendChild(checkbox);
                div.appendChild(label);
                targetContainer.appendChild(div);
            });
        }

        function setupSelectAllCheckboxes() {
            document.querySelectorAll('.select-all-checkbox').forEach(selectAllCb => {
                selectAllCb.addEventListener('change', function() {
                    const group = this.dataset.group;
                    let container, filterClass;
                    if (group === 'fieldVisibility') { container = fieldVisibilityFiltersContainer; filterClass = '.field-visibility-filter'; }
                    else if (group === 'envelopeEvents') { container = envelopeEventTypeFiltersContainer; filterClass = '.event-type-filter'; }
                    else if (group === 'recipientEvents') { container = recipientEventTypeFiltersContainer; filterClass = '.event-type-filter'; }
                    else { return; }
                    if (container) {
                        container.querySelectorAll(filterClass).forEach(cb => cb.checked = this.checked);
                    }
                    applyFilters();
                });
            });
        }
        
        function updateSelectAllCheckboxState(selectAllId) {
            const selectAllCheckbox = document.getElementById(selectAllId);
            if (!selectAllCheckbox) return;
            const group = selectAllCheckbox.dataset.group;
            let container, filterClass;
            if (group === 'fieldVisibility') { container = fieldVisibilityFiltersContainer; filterClass = '.field-visibility-filter'; }
            else if (group === 'envelopeEvents') { container = envelopeEventTypeFiltersContainer; filterClass = '.event-type-filter'; }
            else if (group === 'recipientEvents') { container = recipientEventTypeFiltersContainer; filterClass = '.event-type-filter'; }
            else { return; }
            if (!container) return;
            const checkboxesInGroup = container.querySelectorAll(filterClass);
            if (!checkboxesInGroup || checkboxesInGroup.length === 0) {
                selectAllCheckbox.checked = false; selectAllCheckbox.indeterminate = false; return;
            }
            const total = checkboxesInGroup.length;
            const checkedCount = Array.from(checkboxesInGroup).filter(cb => cb.checked).length;
            if (checkedCount === 0) { selectAllCheckbox.checked = false; selectAllCheckbox.indeterminate = false; }
            else if (checkedCount === total) { selectAllCheckbox.checked = true; selectAllCheckbox.indeterminate = false; }
            else { selectAllCheckbox.checked = false; selectAllCheckbox.indeterminate = true; }
        }

        function populateAllPageFilters() {
            eventFilterConfig.groups.forEach(group => {
                const container = document.getElementById(group.containerId);
                if (container) {
                    populateCheckboxes(container, group.events, group.name.replace(/\s+/g, '-').toLowerCase() + '-types', false, group.selectAllId);
                    updateSelectAllCheckboxState(group.selectAllId);
                }
            });
            if (fieldVisibilityFiltersContainer) {
                 populateCheckboxes(fieldVisibilityFiltersContainer, eventFilterConfig.displayableFields, 'visibility-fields', true, 'selectAllVisibleFields');
                 updateSelectAllCheckboxState('selectAllVisibleFields');
            }
            setupSelectAllCheckboxes();
        }
        
        function renderEvents(eventsToDisplay) {
            eventListContainer.innerHTML = ''; 
            if (!eventsToDisplay || eventsToDisplay.length === 0) {
                eventListContainer.innerHTML = '<p class="tw-text-center tw-py-10">Nenhum evento encontrado com os critérios atuais.</p>';
                return;
            }

            const visibleFieldKeys = {};
            document.querySelectorAll('.field-visibility-filter:checked').forEach(cb => {
                visibleFieldKeys[cb.value] = true; 
            });

            eventsToDisplay.forEach(eventEntry => {
                const card = document.createElement('div');
                card.className = 'event-card'; // Classes Tailwind aplicadas diretamente ou via @apply na <style>
                
                let eventTypeLabel = eventEntry.eventType || 'Desconhecido';
                for (const group of eventFilterConfig.groups) {
                    const foundEvent = group.events.find(e => e.value === (eventEntry.eventType || '').toLowerCase());
                    if (foundEvent) { eventTypeLabel = foundEvent.label; break; }
                }

                let headerContent = `<div class="tw-flex tw-justify-between tw-items-start"><div>`;
                let bodyContent = '';

                eventFilterConfig.displayableFields.forEach(fieldConf => {
                    if (visibleFieldKeys[fieldConf.path]) { 
                        let value = getNestedValue(eventEntry, fieldConf.path);
                        let displayValueHtml = '';

                        if (value === undefined || value === null ) {
                            if(fieldConf.path === 'processingError' && !eventEntry.processingError) return; // Não mostra 'Erro Processamento: N/A' se não houver erro
                            displayValueHtml = '<span class="tw-italic tw-text-gray-500 dark:tw-text-gray-400">N/A</span>';
                        } else if (fieldConf.type === 'datetime') {
                            displayValueHtml = new Date(value).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'medium' });
                        } else if (fieldConf.isEventType) {
                            displayValueHtml = `<span class="tw-font-semibold">${eventTypeLabel}</span>`;
                        } else if (fieldConf.isDocArray && Array.isArray(value)) { // Para envelopeDocuments
                             displayValueHtml = value.map(doc => doc.name || 'Nome Desconhecido').join(', ');
                        } else if (fieldConf.isArray && Array.isArray(value)) { // Para recipientsPreview
                             displayValueHtml = `<ul class="tw-list-disc tw-list-inside tw-ml-4">${value.map(item => `<li>${String(item).replace(/</g, "&lt;").replace(/>/g, "&gt;")}</li>`).join('')}</ul>`;
                        } else if (fieldConf.isPre && typeof value === 'string') { // Para rawPreview
                            displayValueHtml = `<pre class="tw-text-xs">${String(value).replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre>`;
                        } else if (fieldConf.isComplexObject && typeof value === 'object') { // Para recipients
                            displayValueHtml = `<pre class="tw-text-xs">${JSON.stringify(value, null, 2).replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre>`;
                        } else {
                            displayValueHtml = String(value).replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        }
                        
                        const fieldHtml = `<p class="card-field ${fieldConf.path === 'id' ? 'tw-text-xs tw-text-gray-500 dark:tw-text-gray-400' : 'tw-mt-1'}"><strong>${fieldConf.label}:</strong> ${displayValueHtml}</p>`;
                        
                        if (fieldConf.path === 'id' || fieldConf.path === 'receivedAt' || fieldConf.path === 'eventType') {
                            headerContent += fieldHtml;
                        } else {
                            bodyContent += fieldHtml;
                        }
                    }
                });
                headerContent += `</div><button data-event-id="${eventEntry.id}" class="delete-btn tw-flex-shrink-0"><i class="bi bi-trash3"></i> Excluir</button></div>`;
                
                let finalContent = headerContent;
                if(bodyContent.trim() !== ''){
                    finalContent += '<hr class="tw-my-3 dark:tw-border-gray-600">' + bodyContent;
                }
                
                card.innerHTML = finalContent;
                eventListContainer.appendChild(card);
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', handleDeleteEvent);
            });
        }
        
        async function fetchDocusignEvents() {
            if (loadingMessage && !eventListContainer.contains(loadingMessage) && eventListContainer.innerHTML === '') {
                eventListContainer.appendChild(loadingMessage);
            }
            if(loadingMessage) loadingMessage.textContent = 'Carregando eventos...';
            try {
                const response = await fetch('/.netlify/functions/get-docusign-events');
                if (!response.ok) { 
                    const errorData = await response.json().catch(() => ({ message: `Erro HTTP: ${response.status}` }));
                    throw new Error(errorData.message || `Erro HTTP: ${response.status}`);
                }
                allFetchedEvents = await response.json(); 
                populateAllPageFilters(); 
                if (loadingMessage) loadingMessage.remove();
                applyFilters(); 
            } catch (error) { 
                console.error('Erro ao buscar eventos Docusign:', error);
                if (loadingMessage) loadingMessage.remove();
                eventListContainer.innerHTML = `<p class="tw-text-center tw-text-red-500 tw-py-10">Falha ao carregar eventos: ${error.message}</p>`;
            }
        }

        function applyFilters() {
            const filterText = filterInput.value.toLowerCase().trim();
            const selectedEventTypes = Array.from(document.querySelectorAll('.event-type-filter:checked')).map(cb => cb.value.toLowerCase());
            let eventsToDisplay = allFetchedEvents;

            if (selectedEventTypes.length > 0) {
                eventsToDisplay = eventsToDisplay.filter(eventEntry => 
                    eventEntry.eventType && 
                    selectedEventTypes.includes(eventEntry.eventType.toLowerCase())
                );
            }

            if (filterText) {
                eventsToDisplay = eventsToDisplay.filter(eventEntry => {
                    let searchableText = '';
                    eventFilterConfig.displayableFields.forEach(fieldConf => {
                        const value = getNestedValue(eventEntry, fieldConf.path);
                        if (value) {
                            if (typeof value === 'object') { 
                                searchableText += JSON.stringify(value).toLowerCase() + ' ';
                            } else {
                                searchableText += String(value).toLowerCase() + ' ';
                            }
                        }
                    });
                    searchableText += (eventEntry.eventType ? eventEntry.eventType.toLowerCase() : '') + ' ';
                    searchableText += (eventEntry.id ? eventEntry.id.toLowerCase() : '');
                    return searchableText.includes(filterText);
                });
            }
            renderEvents(eventsToDisplay);
        }

        async function handleDeleteEvent(event) {
            const eventId = event.target.closest('.delete-btn').dataset.eventId;
            if (!eventId) return;
            if (confirm(`Tem certeza que deseja excluir o evento com ID: ${eventId}?`)) {
                try {
                    const response = await fetch('/.netlify/functions/delete-docusign-event', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ eventId: eventId })
                    });
                    if (!response.ok) { 
                        const errorData = await response.json().catch(() => ({ message: `Erro HTTP: ${response.status}` }));
                        throw new Error(errorData.message || `Erro ao excluir evento: ${response.statusText}`);
                    }
                    fetchDocusignEvents(); 
                } catch (error) { 
                    console.error("Erro ao excluir evento:", error);
                    alert(`Falha ao excluir evento: ${error.message}`);
                }
            }
        }

        if (refreshDataBtn) refreshDataBtn.addEventListener('click', fetchDocusignEvents);
        if (filterInput) filterInput.addEventListener('input', applyFilters);
        
        fetchDocusignEvents();
      });
    </script>
    <script src="./scripts/components.js"></script>
    <script src="./scripts/index.js"></script>
  </body>
</html>
